\hypertarget{namespacev8_1_1internal_1_1wasm_1_1fuzzing}{}\doxysection{v8\+::internal\+::wasm\+::fuzzing Namespace Reference}
\label{namespacev8_1_1internal_1_1wasm_1_1fuzzing}\index{v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}}
\doxysubsection*{Namespaces}
\begin{DoxyCompactItemize}
\item 
 \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03}{anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}}}
\end{DoxyCompactItemize}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ uint8\+\_\+t $>$ \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a029fd9e1fda0895e20bc29ce1f4bdbe0}{Generate\+Random\+Wasm\+Module}} (\mbox{\hyperlink{classv8_1_1internal_1_1Zone}{Zone}} $\ast$zone, Wasm\+Module\+Generation\+Options options, \mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ const uint8\+\_\+t $>$ data)
\item 
\mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ uint8\+\_\+t $>$ \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_aa6e6cd8b36eacefd6741e4de4920aae0}{Generate\+Wasm\+Module\+For\+Init\+Expressions}} (\mbox{\hyperlink{classv8_1_1internal_1_1Zone}{Zone}} $\ast$zone, \mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ const uint8\+\_\+t $>$ data, \mbox{\hyperlink{namespacev8_1_1internal_a4725962ca3c127eb5871cb47293aee95}{size\+\_\+t}} $\ast$\mbox{\hyperlink{structv8_1_1internal_1_1count}{count}})
\item 
\mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ uint8\+\_\+t $>$ \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a6936bb2d2d2321245a7f08dd9568ba17}{Generate\+Wasm\+Module\+For\+Deopt}} (\mbox{\hyperlink{classv8_1_1internal_1_1Zone}{Zone}} $\ast$zone, \mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ const uint8\+\_\+t $>$ data, std\+::vector$<$ std\+::string $>$ \&callees, std\+::vector$<$ std\+::string $>$ \&inlinees)
\item 
\mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ uint8\+\_\+t $>$ \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a11b6131999053f1b730541b3534bfcd2}{Generate\+Wasm\+Module\+For\+Revec}} (\mbox{\hyperlink{classv8_1_1internal_1_1Zone}{Zone}} $\ast$zone, \mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ const uint8\+\_\+t $>$ data)
\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\mbox{\Hypertarget{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a029fd9e1fda0895e20bc29ce1f4bdbe0}\label{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a029fd9e1fda0895e20bc29ce1f4bdbe0}} 
\index{v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}!GenerateRandomWasmModule@{GenerateRandomWasmModule}}
\index{GenerateRandomWasmModule@{GenerateRandomWasmModule}!v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}}
\doxysubsubsection{\texorpdfstring{GenerateRandomWasmModule()}{GenerateRandomWasmModule()}}
{\footnotesize\ttfamily \mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$uint8\+\_\+t$>$ v8\+::internal\+::wasm\+::fuzzing\+::\+Generate\+Random\+Wasm\+Module (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classv8_1_1internal_1_1Zone}{Zone}} $\ast$}]{zone,  }\item[{Wasm\+Module\+Generation\+Options}]{options,  }\item[{\mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ const uint8\+\_\+t $>$}]{data }\end{DoxyParamCaption})}



Definition at line 4345 of file random-\/module-\/generation.\+cc.


\begin{DoxyCode}{0}
\DoxyCodeLine{4347                                     \{}
\DoxyCodeLine{4348   WasmModuleBuilder builder(zone);}
\DoxyCodeLine{4349 }
\DoxyCodeLine{4350   \textcolor{comment}{// Split input data in two parts:}}
\DoxyCodeLine{4351   \textcolor{comment}{// -\/ One for the "{}module"{} (types, globals, ..)}}
\DoxyCodeLine{4352   \textcolor{comment}{// -\/ One for all the function bodies}}
\DoxyCodeLine{4353   \textcolor{comment}{// This prevents using a too large portion on the module resulting in}}
\DoxyCodeLine{4354   \textcolor{comment}{// uninteresting function bodies.}}
\DoxyCodeLine{4355   DataRange module\_range(data);}
\DoxyCodeLine{4356   DataRange functions\_range = module\_range.split();}
\DoxyCodeLine{4357   std::vector<ModuleTypeIndex> function\_signatures;}
\DoxyCodeLine{4358 }
\DoxyCodeLine{4359   \textcolor{comment}{// At least 1 function is needed.}}
\DoxyCodeLine{4360   \textcolor{keywordtype}{int} max\_num\_functions = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a09efd81c34c8e231e0d6195e2e777c46}{MaxNumOfFunctions}}();}
\DoxyCodeLine{4361   \mbox{\hyperlink{src_2base_2logging_8h_a1c7c9b7f14b9a33ea69cbe4578016a19}{CHECK\_GE}}(max\_num\_functions, 1);}
\DoxyCodeLine{4362   uint8\_t num\_functions = 1 + (module\_range.get<uint8\_t>() \% max\_num\_functions);}
\DoxyCodeLine{4363 }
\DoxyCodeLine{4364   \textcolor{comment}{// In case of WasmGC expressions:}}
\DoxyCodeLine{4365   \textcolor{comment}{// Add struct and array types first so that we get a chance to generate}}
\DoxyCodeLine{4366   \textcolor{comment}{// these types in function signatures.}}
\DoxyCodeLine{4367   \textcolor{comment}{// Currently, `BodyGen` assumes this order for struct/array/signature}}
\DoxyCodeLine{4368   \textcolor{comment}{// definitions.}}
\DoxyCodeLine{4369   \textcolor{comment}{// Otherwise, for non-\/WasmGC we can't use structs/arrays.}}
\DoxyCodeLine{4370   uint8\_t num\_structs = 0;}
\DoxyCodeLine{4371   uint8\_t num\_arrays = 0;}
\DoxyCodeLine{4372   std::vector<ModuleTypeIndex> array\_types;}
\DoxyCodeLine{4373   std::vector<ModuleTypeIndex> struct\_types;}
\DoxyCodeLine{4374 }
\DoxyCodeLine{4375   \textcolor{comment}{// In case of WasmGC expressions:}}
\DoxyCodeLine{4376   \textcolor{comment}{// We always add two default array types with mutable i8 and i16 elements,}}
\DoxyCodeLine{4377   \textcolor{comment}{// respectively.}}
\DoxyCodeLine{4378   constexpr uint8\_t kNumDefaultArrayTypesForWasmGC = 2;}
\DoxyCodeLine{4379   \textcolor{keywordflow}{if} (options.generate\_wasm\_gc()) \{}
\DoxyCodeLine{4380     \textcolor{comment}{// We need at least one struct and one array in order to support}}
\DoxyCodeLine{4381     \textcolor{comment}{// WasmInitExpr for abstract types.}}
\DoxyCodeLine{4382     num\_structs = 1 + module\_range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a0715189293751f7b8f6ac34a74057282}{kMaxStructs}};}
\DoxyCodeLine{4383     num\_arrays = kNumDefaultArrayTypesForWasmGC +}
\DoxyCodeLine{4384                  module\_range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_adae57d01cf1790d3aa59bb4ae3f1c2ff}{kMaxArrays}};}
\DoxyCodeLine{4385   \}}
\DoxyCodeLine{4386 }
\DoxyCodeLine{4387   uint8\_t num\_signatures = num\_functions;}
\DoxyCodeLine{4388   ModuleGen gen\_module(zone, options, \&builder, \&module\_range, num\_functions,}
\DoxyCodeLine{4389                        num\_structs, num\_arrays, num\_signatures);}
\DoxyCodeLine{4390 }
\DoxyCodeLine{4391   \textcolor{comment}{// Add random number of memories.}}
\DoxyCodeLine{4392   \textcolor{comment}{// TODO(v8:14674): Add a mode without declaring any memory or memory}}
\DoxyCodeLine{4393   \textcolor{comment}{// instructions.}}
\DoxyCodeLine{4394   gen\_module.GenerateRandomMemories();}
\DoxyCodeLine{4395 }
\DoxyCodeLine{4396   uint8\_t current\_type\_index = 0;}
\DoxyCodeLine{4397   \textcolor{comment}{// In case of WasmGC expressions, we create recursive groups for the recursive}}
\DoxyCodeLine{4398   \textcolor{comment}{// types.}}
\DoxyCodeLine{4399   std::map<uint8\_t, uint8\_t> explicit\_rec\_groups;}
\DoxyCodeLine{4400   \textcolor{keywordflow}{if} (options.generate\_wasm\_gc()) \{}
\DoxyCodeLine{4401     \textcolor{comment}{// Put the types into random recursive groups.}}
\DoxyCodeLine{4402     explicit\_rec\_groups = gen\_module.GenerateRandomRecursiveGroups(}
\DoxyCodeLine{4403         kNumDefaultArrayTypesForWasmGC);}
\DoxyCodeLine{4404 }
\DoxyCodeLine{4405     \textcolor{comment}{// Add default array types.}}
\DoxyCodeLine{4406     \textcolor{keyword}{static} constexpr ModuleTypeIndex kArrayI8\{0\};}
\DoxyCodeLine{4407     \textcolor{keyword}{static} constexpr ModuleTypeIndex kArrayI16\{1\};}
\DoxyCodeLine{4408     \{}
\DoxyCodeLine{4409       ArrayType* a8 = zone-\/>New<ArrayType>(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a5f3afadb8ac8aa1c39b17545c7facf09}{kWasmI8}}, 1);}
\DoxyCodeLine{4410       \mbox{\hyperlink{src_2base_2logging_8h_aca32614b4d2aea7dd9abdeb222bf02f3}{CHECK\_EQ}}(kArrayI8, builder.AddArrayType(a8, \textcolor{keyword}{true}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a9426d91ec5f89dd5402e6579bd09e9cc}{kNoSuperType}}));}
\DoxyCodeLine{4411       array\_types.push\_back(kArrayI8);}
\DoxyCodeLine{4412       ArrayType* a16 = zone-\/>New<ArrayType>(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_af2d01915a8d185e3b4b8e95908eca2d7}{kWasmI16}}, 1);}
\DoxyCodeLine{4413       \mbox{\hyperlink{src_2base_2logging_8h_aca32614b4d2aea7dd9abdeb222bf02f3}{CHECK\_EQ}}(kArrayI16, builder.AddArrayType(a16, \textcolor{keyword}{true}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a9426d91ec5f89dd5402e6579bd09e9cc}{kNoSuperType}}));}
\DoxyCodeLine{4414       array\_types.push\_back(kArrayI16);}
\DoxyCodeLine{4415     \}}
\DoxyCodeLine{4416     static\_assert(kNumDefaultArrayTypesForWasmGC == kArrayI16.index + 1);}
\DoxyCodeLine{4417     current\_type\_index = kNumDefaultArrayTypesForWasmGC;}
\DoxyCodeLine{4418 }
\DoxyCodeLine{4419     \textcolor{comment}{// Add randomly generated structs.}}
\DoxyCodeLine{4420     gen\_module.GenerateRandomStructs(explicit\_rec\_groups, struct\_types,}
\DoxyCodeLine{4421                                      current\_type\_index,}
\DoxyCodeLine{4422                                      kNumDefaultArrayTypesForWasmGC);}
\DoxyCodeLine{4423     \mbox{\hyperlink{src_2base_2logging_8h_af9c313d74155f7f201955a939e24c71f}{DCHECK\_EQ}}(current\_type\_index, kNumDefaultArrayTypesForWasmGC + num\_structs);}
\DoxyCodeLine{4424 }
\DoxyCodeLine{4425     \textcolor{comment}{// Add randomly generated arrays.}}
\DoxyCodeLine{4426     gen\_module.GenerateRandomArrays(explicit\_rec\_groups, array\_types,}
\DoxyCodeLine{4427                                     current\_type\_index);}
\DoxyCodeLine{4428     \mbox{\hyperlink{src_2base_2logging_8h_af9c313d74155f7f201955a939e24c71f}{DCHECK\_EQ}}(current\_type\_index, num\_structs + num\_arrays);}
\DoxyCodeLine{4429   \}}
\DoxyCodeLine{4430 }
\DoxyCodeLine{4431   \textcolor{comment}{// We keep the signature for the first (main) function constant.}}
\DoxyCodeLine{4432   constexpr \textcolor{keywordtype}{bool} kIsFinal = \textcolor{keyword}{true};}
\DoxyCodeLine{4433   \textcolor{keyword}{auto} kMainFnSig = FixedSizeSignature<ValueType>::Returns(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}}).Params(}
\DoxyCodeLine{4434       \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}});}
\DoxyCodeLine{4435   function\_signatures.push\_back(}
\DoxyCodeLine{4436       builder.ForceAddSignature(\&kMainFnSig, kIsFinal));}
\DoxyCodeLine{4437   current\_type\_index++;}
\DoxyCodeLine{4438 }
\DoxyCodeLine{4439   \textcolor{comment}{// Add randomly generated signatures.}}
\DoxyCodeLine{4440   gen\_module.GenerateRandomFunctionSigs(}
\DoxyCodeLine{4441       explicit\_rec\_groups, function\_signatures, current\_type\_index, kIsFinal);}
\DoxyCodeLine{4442   \mbox{\hyperlink{src_2base_2logging_8h_af9c313d74155f7f201955a939e24c71f}{DCHECK\_EQ}}(current\_type\_index, num\_functions + num\_structs + num\_arrays);}
\DoxyCodeLine{4443 }
\DoxyCodeLine{4444   \textcolor{comment}{// Add exceptions.}}
\DoxyCodeLine{4445   \textcolor{keywordtype}{int} num\_exceptions = 1 + (module\_range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af71b678ded0cb5aca0dd86c9b4f038c3}{kMaxExceptions}});}
\DoxyCodeLine{4446   gen\_module.GenerateRandomExceptions(num\_exceptions);}
\DoxyCodeLine{4447 }
\DoxyCodeLine{4448   \textcolor{comment}{// In case of WasmGC expressions:}}
\DoxyCodeLine{4449   \textcolor{comment}{// Add the "{}wasm:js-\/string"{} imports to the module. They may or may not be}}
\DoxyCodeLine{4450   \textcolor{comment}{// used later, but they'll always be available.}}
\DoxyCodeLine{4451   StringImports strings = options.generate\_wasm\_gc()}
\DoxyCodeLine{4452                               ? gen\_module.AddImportedStringImports()}
\DoxyCodeLine{4453                               : StringImports();}
\DoxyCodeLine{4454 }
\DoxyCodeLine{4455   \textcolor{comment}{// Generate function declarations before tables. This will be needed once we}}
\DoxyCodeLine{4456   \textcolor{comment}{// have typed-\/function tables.}}
\DoxyCodeLine{4457   std::vector<WasmFunctionBuilder*> functions;}
\DoxyCodeLine{4458   functions.reserve(num\_functions);}
\DoxyCodeLine{4459   \textcolor{keywordflow}{for} (uint8\_t \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_functions; \mbox{\hyperlink{namespacev8_1_1internal}{i}}++) \{}
\DoxyCodeLine{4460     \textcolor{comment}{// If we are using wasm-\/gc, we cannot allow signature normalization}}
\DoxyCodeLine{4461     \textcolor{comment}{// performed by adding a function by \{FunctionSig\}, because we emit}}
\DoxyCodeLine{4462     \textcolor{comment}{// everything in one recursive group which blocks signature}}
\DoxyCodeLine{4463     \textcolor{comment}{// canonicalization.}}
\DoxyCodeLine{4464     \textcolor{comment}{// TODO(14034): Relax this when we implement proper recursive-\/group}}
\DoxyCodeLine{4465     \textcolor{comment}{// support.}}
\DoxyCodeLine{4466     functions.push\_back(builder.AddFunction(function\_signatures[\mbox{\hyperlink{namespacev8_1_1internal}{i}}]));}
\DoxyCodeLine{4467   \}}
\DoxyCodeLine{4468 }
\DoxyCodeLine{4469   \textcolor{comment}{// Generate tables before function bodies, so they are available for table}}
\DoxyCodeLine{4470   \textcolor{comment}{// operations. Generate tables before the globals, so tables don't}}
\DoxyCodeLine{4471   \textcolor{comment}{// accidentally use globals in their initializer expressions.}}
\DoxyCodeLine{4472   \textcolor{comment}{// Always generate at least one table for call\_indirect.}}
\DoxyCodeLine{4473   gen\_module.GenerateRandomTables(array\_types, struct\_types);}
\DoxyCodeLine{4474 }
\DoxyCodeLine{4475   \textcolor{comment}{// Add globals.}}
\DoxyCodeLine{4476   \textcolor{keyword}{auto} [globals, mutable\_globals] =}
\DoxyCodeLine{4477       gen\_module.GenerateRandomGlobals(array\_types, struct\_types);}
\DoxyCodeLine{4478 }
\DoxyCodeLine{4479   \textcolor{comment}{// Add passive data segments.}}
\DoxyCodeLine{4480   \textcolor{keywordtype}{int} num\_data\_segments = module\_range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a2f120e601c51bf84c21c1072594c3b03}{kMaxPassiveDataSegments}};}
\DoxyCodeLine{4481   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_data\_segments; \mbox{\hyperlink{namespacev8_1_1internal}{i}}++) \{}
\DoxyCodeLine{4482     \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a66f258d156112784e0c4175bedb6db8a}{GeneratePassiveDataSegment}}(\&module\_range, \&builder);}
\DoxyCodeLine{4483   \}}
\DoxyCodeLine{4484 }
\DoxyCodeLine{4485   \textcolor{comment}{// Generate function bodies.}}
\DoxyCodeLine{4486   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_functions; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{4487     WasmFunctionBuilder* f = functions[\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}];}
\DoxyCodeLine{4488     \textcolor{comment}{// On the last function don't split the DataRange but just use the}}
\DoxyCodeLine{4489     \textcolor{comment}{// existing DataRange.}}
\DoxyCodeLine{4490     DataRange function\_range = \mbox{\hyperlink{namespacev8_1_1internal}{i}} != num\_functions -\/ 1}
\DoxyCodeLine{4491                                    ? functions\_range.split()}
\DoxyCodeLine{4492                                    : std::move(functions\_range);}
\DoxyCodeLine{4493     BodyGen gen\_body(options, f, function\_signatures, globals, mutable\_globals,}
\DoxyCodeLine{4494                      struct\_types, array\_types, strings, \&function\_range);}
\DoxyCodeLine{4495     \textcolor{keyword}{const} \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a1a17c60bc1e8b8ad11208d7b0d3ec5a9}{FunctionSig}}* \mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}} = f-\/>signature();}
\DoxyCodeLine{4496     base::Vector<const ValueType> return\_types(\mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}}-\/>returns().begin(),}
\DoxyCodeLine{4497                                                \mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}}-\/>return\_count());}
\DoxyCodeLine{4498     gen\_body.InitializeNonDefaultableLocals(\&function\_range);}
\DoxyCodeLine{4499     gen\_body.Generate(return\_types, \&function\_range);}
\DoxyCodeLine{4500     f-\/>Emit(kExprEnd);}
\DoxyCodeLine{4501     \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespacev8_1_1internal}{i}} == 0) builder.AddExport(\mbox{\hyperlink{namespacev8_1_1base_aaa0a202e5ad0d494cc88496b8fafa571}{base::CStrVector}}(\textcolor{stringliteral}{"{}main"{}}), f);}
\DoxyCodeLine{4502   \}}
\DoxyCodeLine{4503 }
\DoxyCodeLine{4504   ZoneBuffer buffer\{zone\};}
\DoxyCodeLine{4505   builder.WriteTo(\&buffer);}
\DoxyCodeLine{4506   \textcolor{keywordflow}{return} \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(buffer);}
\DoxyCodeLine{4507 \}}

\end{DoxyCode}


References v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Array\+Type(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Export(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Function(), CHECK\+\_\+\+EQ, CHECK\+\_\+\+GE, v8\+::base\+::\+CStr\+Vector(), DCHECK\+\_\+\+EQ, v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Force\+Add\+Signature(), v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Generate\+Passive\+Data\+Segment(), v8\+::internal\+::anonymous\+\_\+namespace\{json-\/stringifier.\+cc\}\+::i, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Arrays, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Exceptions, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Passive\+Data\+Segments, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Structs, v8\+::internal\+::wasm\+::k\+No\+Super\+Type, v8\+::internal\+::wasm\+::k\+Wasm\+I16, v8\+::internal\+::wasm\+::k\+Wasm\+I32, v8\+::internal\+::wasm\+::k\+Wasm\+I8, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Max\+Num\+Of\+Functions(), v8\+::internal\+::\+Zone\+::\+New(), v8\+::internal\+::\+Fixed\+Size\+Signature$<$ T, k\+Num\+Returns, k\+Num\+Params $>$\+::\+Returns(), v8\+::internal\+::sig, v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::signature(), v8\+::base\+::\+Vector\+Of(), and v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Write\+To().

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a029fd9e1fda0895e20bc29ce1f4bdbe0_cgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a6936bb2d2d2321245a7f08dd9568ba17}\label{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a6936bb2d2d2321245a7f08dd9568ba17}} 
\index{v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}!GenerateWasmModuleForDeopt@{GenerateWasmModuleForDeopt}}
\index{GenerateWasmModuleForDeopt@{GenerateWasmModuleForDeopt}!v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}}
\doxysubsubsection{\texorpdfstring{GenerateWasmModuleForDeopt()}{GenerateWasmModuleForDeopt()}}
{\footnotesize\ttfamily \mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$uint8\+\_\+t$>$ v8\+::internal\+::wasm\+::fuzzing\+::\+Generate\+Wasm\+Module\+For\+Deopt (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classv8_1_1internal_1_1Zone}{Zone}} $\ast$}]{zone,  }\item[{\mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ const uint8\+\_\+t $>$}]{data,  }\item[{std\+::vector$<$ std\+::string $>$ \&}]{callees,  }\item[{std\+::vector$<$ std\+::string $>$ \&}]{inlinees }\end{DoxyParamCaption})}



Definition at line 4780 of file random-\/module-\/generation.\+cc.


\begin{DoxyCode}{0}
\DoxyCodeLine{4782                                                                    \{}
\DoxyCodeLine{4783   \textcolor{comment}{// Don't limit the features for the deopt fuzzer.}}
\DoxyCodeLine{4784   constexpr WasmModuleGenerationOptions options =}
\DoxyCodeLine{4785       WasmModuleGenerationOptions::All();}
\DoxyCodeLine{4786   WasmModuleBuilder builder(zone);}
\DoxyCodeLine{4787 }
\DoxyCodeLine{4788   DataRange range(data);}
\DoxyCodeLine{4789   std::vector<ModuleTypeIndex> function\_signatures;}
\DoxyCodeLine{4790   std::vector<ModuleTypeIndex> array\_types;}
\DoxyCodeLine{4791   std::vector<ModuleTypeIndex> struct\_types;}
\DoxyCodeLine{4792 }
\DoxyCodeLine{4793   \textcolor{keyword}{const} \textcolor{keywordtype}{int} kMaxCallTargets = 5;}
\DoxyCodeLine{4794   \textcolor{keyword}{const} \textcolor{keywordtype}{int} kMaxInlinees = 3;}
\DoxyCodeLine{4795 }
\DoxyCodeLine{4796   \textcolor{comment}{// We need at least 2 call targets to be able to trigger a deopt.}}
\DoxyCodeLine{4797   \textcolor{keyword}{const} \textcolor{keywordtype}{int} num\_call\_targets = 2 + range.get<uint8\_t>() \% (kMaxCallTargets -\/ 1);}
\DoxyCodeLine{4798   \textcolor{keyword}{const} \textcolor{keywordtype}{int} num\_inlinees = range.get<uint8\_t>() \% (kMaxInlinees + 1);}
\DoxyCodeLine{4799 }
\DoxyCodeLine{4800   \textcolor{comment}{// 1 main function + x inlinees + x callees.}}
\DoxyCodeLine{4801   uint8\_t num\_functions = 1 + num\_inlinees + num\_call\_targets;}
\DoxyCodeLine{4802   \textcolor{comment}{// 1 signature for all the callees, 1 signature for the main function +}}
\DoxyCodeLine{4803   \textcolor{comment}{// 1 signature per inlinee.}}
\DoxyCodeLine{4804   uint8\_t num\_signatures = 2 + num\_inlinees;}
\DoxyCodeLine{4805 }
\DoxyCodeLine{4806   uint8\_t num\_structs = 1 + range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a0715189293751f7b8f6ac34a74057282}{kMaxStructs}};}
\DoxyCodeLine{4807   \textcolor{comment}{// In case of WasmGC expressions:}}
\DoxyCodeLine{4808   \textcolor{comment}{// We always add two default array types with mutable i8 and i16 elements,}}
\DoxyCodeLine{4809   \textcolor{comment}{// respectively.}}
\DoxyCodeLine{4810   constexpr uint8\_t kNumDefaultArrayTypesForWasmGC = 2;}
\DoxyCodeLine{4811   uint8\_t num\_arrays =}
\DoxyCodeLine{4812       range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_adae57d01cf1790d3aa59bb4ae3f1c2ff}{kMaxArrays}} + kNumDefaultArrayTypesForWasmGC;}
\DoxyCodeLine{4813   \textcolor{comment}{// Just ignoring user-\/defined signature types in the signatures.}}
\DoxyCodeLine{4814   \mbox{\hyperlink{namespaceunibrow_a0869a94c1a582a2b47889b990444deb9}{uint16\_t}} num\_types = num\_structs + num\_arrays;}
\DoxyCodeLine{4815 }
\DoxyCodeLine{4816   uint8\_t current\_type\_index = kNumDefaultArrayTypesForWasmGC;}
\DoxyCodeLine{4817 }
\DoxyCodeLine{4818   \textcolor{comment}{// Add random-\/generated types.}}
\DoxyCodeLine{4819   ModuleGen gen\_module(zone, options, \&builder, \&range, num\_functions,}
\DoxyCodeLine{4820                        num\_structs, num\_arrays, num\_signatures);}
\DoxyCodeLine{4821 }
\DoxyCodeLine{4822   gen\_module.GenerateRandomMemories();}
\DoxyCodeLine{4823   std::map<uint8\_t, uint8\_t> explicit\_rec\_groups =}
\DoxyCodeLine{4824       gen\_module.GenerateRandomRecursiveGroups(kNumDefaultArrayTypesForWasmGC);}
\DoxyCodeLine{4825   \textcolor{comment}{// Add default array types.}}
\DoxyCodeLine{4826   \textcolor{keyword}{static} constexpr ModuleTypeIndex kArrayI8\{0\};}
\DoxyCodeLine{4827   \textcolor{keyword}{static} constexpr ModuleTypeIndex kArrayI16\{1\};}
\DoxyCodeLine{4828   \{}
\DoxyCodeLine{4829     ArrayType* a8 = zone-\/>New<ArrayType>(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a5f3afadb8ac8aa1c39b17545c7facf09}{kWasmI8}}, \textcolor{keyword}{true});}
\DoxyCodeLine{4830     \mbox{\hyperlink{src_2base_2logging_8h_aca32614b4d2aea7dd9abdeb222bf02f3}{CHECK\_EQ}}(kArrayI8, builder.AddArrayType(a8, \textcolor{keyword}{true}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a9426d91ec5f89dd5402e6579bd09e9cc}{kNoSuperType}}));}
\DoxyCodeLine{4831     array\_types.push\_back(kArrayI8);}
\DoxyCodeLine{4832     ArrayType* a16 = zone-\/>New<ArrayType>(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_af2d01915a8d185e3b4b8e95908eca2d7}{kWasmI16}}, \textcolor{keyword}{true});}
\DoxyCodeLine{4833     \mbox{\hyperlink{src_2base_2logging_8h_aca32614b4d2aea7dd9abdeb222bf02f3}{CHECK\_EQ}}(kArrayI16, builder.AddArrayType(a16, \textcolor{keyword}{true}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a9426d91ec5f89dd5402e6579bd09e9cc}{kNoSuperType}}));}
\DoxyCodeLine{4834     array\_types.push\_back(kArrayI16);}
\DoxyCodeLine{4835   \}}
\DoxyCodeLine{4836   static\_assert(kNumDefaultArrayTypesForWasmGC == kArrayI16.index + 1);}
\DoxyCodeLine{4837   gen\_module.GenerateRandomStructs(explicit\_rec\_groups, struct\_types,}
\DoxyCodeLine{4838                                    current\_type\_index,}
\DoxyCodeLine{4839                                    kNumDefaultArrayTypesForWasmGC);}
\DoxyCodeLine{4840   \mbox{\hyperlink{src_2base_2logging_8h_af9c313d74155f7f201955a939e24c71f}{DCHECK\_EQ}}(current\_type\_index, kNumDefaultArrayTypesForWasmGC + num\_structs);}
\DoxyCodeLine{4841   gen\_module.GenerateRandomArrays(explicit\_rec\_groups, array\_types,}
\DoxyCodeLine{4842                                   current\_type\_index);}
\DoxyCodeLine{4843   \mbox{\hyperlink{src_2base_2logging_8h_af9c313d74155f7f201955a939e24c71f}{DCHECK\_EQ}}(current\_type\_index, num\_structs + num\_arrays);}
\DoxyCodeLine{4844 }
\DoxyCodeLine{4845   \textcolor{comment}{// Create signature for call target.}}
\DoxyCodeLine{4846   std::vector<ValueType> return\_types =}
\DoxyCodeLine{4847       \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af9bd96390b0b3e34a32b1e3e307a2ce8}{GenerateTypes}}(options, \&range, num\_types);}
\DoxyCodeLine{4848   constexpr \textcolor{keywordtype}{bool} kIsFinal = \textcolor{keyword}{true};}
\DoxyCodeLine{4849   \textcolor{keyword}{const} \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a1a17c60bc1e8b8ad11208d7b0d3ec5a9}{FunctionSig}}* target\_sig = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a1724a388014541082690d4718b8e4def}{CreateSignature}}(}
\DoxyCodeLine{4850       builder.zone(), \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af9bd96390b0b3e34a32b1e3e307a2ce8}{GenerateTypes}}(options, \&range, num\_types)),}
\DoxyCodeLine{4851       \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(return\_types));}
\DoxyCodeLine{4852   ModuleTypeIndex target\_sig\_index =}
\DoxyCodeLine{4853       builder.ForceAddSignature(target\_sig, kIsFinal);}
\DoxyCodeLine{4854 }
\DoxyCodeLine{4855   function\_signatures.reserve(num\_call\_targets);}
\DoxyCodeLine{4856   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_call\_targets; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{4857     \textcolor{comment}{// Simplification: All call targets of a call\_ref / call\_indirect have the}}
\DoxyCodeLine{4858     \textcolor{comment}{// same signature.}}
\DoxyCodeLine{4859     function\_signatures.push\_back(target\_sig\_index);}
\DoxyCodeLine{4860   \}}
\DoxyCodeLine{4861 }
\DoxyCodeLine{4862   \textcolor{comment}{// Create signatures for inlinees.}}
\DoxyCodeLine{4863   \textcolor{comment}{// Use the same return types with a certain chance. This increases the chance}}
\DoxyCodeLine{4864   \textcolor{comment}{// to emit return calls.}}
\DoxyCodeLine{4865   uint8\_t use\_same\_return = range.get<uint8\_t>();}
\DoxyCodeLine{4866   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_inlinees; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{4867     \textcolor{keywordflow}{if} ((use\_same\_return \& (1 << \mbox{\hyperlink{namespacev8_1_1internal}{i}})) == 0) \{}
\DoxyCodeLine{4868       return\_types = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af9bd96390b0b3e34a32b1e3e307a2ce8}{GenerateTypes}}(options, \&range, num\_types);}
\DoxyCodeLine{4869     \}}
\DoxyCodeLine{4870     \textcolor{keyword}{const} \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a1a17c60bc1e8b8ad11208d7b0d3ec5a9}{FunctionSig}}* inlinee\_sig = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a1724a388014541082690d4718b8e4def}{CreateSignature}}(}
\DoxyCodeLine{4871         builder.zone(),}
\DoxyCodeLine{4872         \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af9bd96390b0b3e34a32b1e3e307a2ce8}{GenerateTypes}}(options, \&range, num\_types)),}
\DoxyCodeLine{4873         \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(return\_types));}
\DoxyCodeLine{4874     function\_signatures.push\_back(}
\DoxyCodeLine{4875         builder.ForceAddSignature(inlinee\_sig, kIsFinal));}
\DoxyCodeLine{4876   \}}
\DoxyCodeLine{4877 }
\DoxyCodeLine{4878   \textcolor{comment}{// Create signature for main function.}}
\DoxyCodeLine{4879   \textcolor{keyword}{const} \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a1a17c60bc1e8b8ad11208d7b0d3ec5a9}{FunctionSig}}* main\_sig =}
\DoxyCodeLine{4880       \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a1724a388014541082690d4718b8e4def}{CreateSignature}}(builder.zone(), \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(\{ValueType\{kWasmI32\}\}),}
\DoxyCodeLine{4881                       \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(\{ValueType\{\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}}\}\}));}
\DoxyCodeLine{4882   function\_signatures.push\_back(builder.ForceAddSignature(main\_sig, kIsFinal));}
\DoxyCodeLine{4883 }
\DoxyCodeLine{4884   \mbox{\hyperlink{src_2base_2logging_8h_af9c313d74155f7f201955a939e24c71f}{DCHECK\_EQ}}(function\_signatures.back().index,}
\DoxyCodeLine{4885             num\_structs + num\_arrays + num\_signatures -\/ 1);}
\DoxyCodeLine{4886 }
\DoxyCodeLine{4887   \textcolor{comment}{// This needs to be done after the signatures are added.}}
\DoxyCodeLine{4888   \textcolor{keywordtype}{int} num\_exceptions = 1 + range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af71b678ded0cb5aca0dd86c9b4f038c3}{kMaxExceptions}};}
\DoxyCodeLine{4889   gen\_module.GenerateRandomExceptions(num\_exceptions);}
\DoxyCodeLine{4890   StringImports strings = gen\_module.AddImportedStringImports();}
\DoxyCodeLine{4891 }
\DoxyCodeLine{4892   \textcolor{comment}{// Add functions to module.}}
\DoxyCodeLine{4893   std::vector<WasmFunctionBuilder*> functions;}
\DoxyCodeLine{4894   \mbox{\hyperlink{src_2base_2logging_8h_af9c313d74155f7f201955a939e24c71f}{DCHECK\_EQ}}(num\_functions, function\_signatures.size());}
\DoxyCodeLine{4895   functions.reserve(num\_functions);}
\DoxyCodeLine{4896   \textcolor{keywordflow}{for} (uint8\_t \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_functions; \mbox{\hyperlink{namespacev8_1_1internal}{i}}++) \{}
\DoxyCodeLine{4897     functions.push\_back(builder.AddFunction(function\_signatures[\mbox{\hyperlink{namespacev8_1_1internal}{i}}]));}
\DoxyCodeLine{4898   \}}
\DoxyCodeLine{4899 }
\DoxyCodeLine{4900   uint32\_t num\_entries = num\_call\_targets + num\_inlinees;}
\DoxyCodeLine{4901   \textcolor{keywordtype}{bool} use\_table64 = range.get<\textcolor{keywordtype}{bool}>();}
\DoxyCodeLine{4902   \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_aca3af72b5da01dfb563e4c5f56af8952}{AddressType}} address\_type =}
\DoxyCodeLine{4903       use\_table64 ? AddressType::kI64 : AddressType::kI32;}
\DoxyCodeLine{4904   uint32\_t table\_index =}
\DoxyCodeLine{4905       builder.AddTable(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a90941f620285a912a302a3aced092560}{kWasmFuncRef}}, num\_entries, num\_entries, address\_type);}
\DoxyCodeLine{4906   WasmModuleBuilder::WasmElemSegment segment(}
\DoxyCodeLine{4907       zone, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a90941f620285a912a302a3aced092560}{kWasmFuncRef}}, table\_index,}
\DoxyCodeLine{4908       use\_table64 ? WasmInitExpr(int64\_t\{0\}) : WasmInitExpr(0));}
\DoxyCodeLine{4909   \textcolor{keywordflow}{for} (uint32\_t \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_entries; \mbox{\hyperlink{namespacev8_1_1internal}{i}}++) \{}
\DoxyCodeLine{4910     segment.entries.emplace\_back(}
\DoxyCodeLine{4911         WasmModuleBuilder::WasmElemSegment::Entry::kRefFuncEntry,}
\DoxyCodeLine{4912         builder.NumImportedFunctions() + \mbox{\hyperlink{namespacev8_1_1internal}{i}});}
\DoxyCodeLine{4913   \}}
\DoxyCodeLine{4914   builder.AddElementSegment(std::move(segment));}
\DoxyCodeLine{4915 }
\DoxyCodeLine{4916   gen\_module.GenerateRandomTables(array\_types, struct\_types);}
\DoxyCodeLine{4917 }
\DoxyCodeLine{4918   \textcolor{comment}{// Create global for call target index.}}
\DoxyCodeLine{4919   \textcolor{comment}{// Simplification: This global is used to specify the call target at the deopt}}
\DoxyCodeLine{4920   \textcolor{comment}{// point instead of passing the call target around dynamically.}}
\DoxyCodeLine{4921   uint32\_t global\_index =}
\DoxyCodeLine{4922       builder.AddExportedGlobal(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}}, \textcolor{keyword}{true}, WasmInitExpr(0),}
\DoxyCodeLine{4923                                 \mbox{\hyperlink{namespacev8_1_1base_a00f1f354f310e47ef4694667601d62fb}{base::StaticCharVector}}(\textcolor{stringliteral}{"{}call\_target\_index"{}}));}
\DoxyCodeLine{4924 }
\DoxyCodeLine{4925   \textcolor{comment}{// Create inlinee bodies.}}
\DoxyCodeLine{4926   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_inlinees; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{4927     uint32\_t declared\_func\_index = \mbox{\hyperlink{namespacev8_1_1internal}{i}} + num\_call\_targets;}
\DoxyCodeLine{4928     WasmFunctionBuilder* f = functions[declared\_func\_index];}
\DoxyCodeLine{4929     DataRange function\_range = range.split();}
\DoxyCodeLine{4930     BodyGen gen\_body(options, f, function\_signatures, \{\}, \{\}, struct\_types,}
\DoxyCodeLine{4931                      array\_types, strings, \&function\_range);}
\DoxyCodeLine{4932     gen\_body.InitializeNonDefaultableLocals(\&function\_range);}
\DoxyCodeLine{4933     \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespacev8_1_1internal}{i}} == 0) \{}
\DoxyCodeLine{4934       \textcolor{comment}{// For the inner-\/most inlinee, emit the deopt point (e.g. a call\_ref).}}
\DoxyCodeLine{4935       \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_addae1cc9d8e10a41a85fbd188db4f081}{EmitDeoptAndReturnValues}}(gen\_body, f, target\_sig, target\_sig\_index,}
\DoxyCodeLine{4936                                global\_index, table\_index, use\_table64,}
\DoxyCodeLine{4937                                \&function\_range);}
\DoxyCodeLine{4938     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{4939       \textcolor{comment}{// All other inlinees call the previous inlinee.}}
\DoxyCodeLine{4940       uint32\_t callee\_declared\_index = declared\_func\_index -\/ 1;}
\DoxyCodeLine{4941       \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a965a6586b49189e8ffcea8e0a570923e}{EmitCallAndReturnValues}}(gen\_body, f, functions[callee\_declared\_index],}
\DoxyCodeLine{4942                               table\_index, use\_table64, \&function\_range);}
\DoxyCodeLine{4943     \}}
\DoxyCodeLine{4944     f-\/>Emit(kExprEnd);}
\DoxyCodeLine{4945     \textcolor{keyword}{auto} buffer = zone-\/>AllocateVector<\textcolor{keywordtype}{char}>(32);}
\DoxyCodeLine{4946     \textcolor{keywordtype}{size\_t} len = \mbox{\hyperlink{namespacev8_1_1base_a36caaf43a3f7761ae90d699b961f0239}{base::SNPrintF}}(buffer, \textcolor{stringliteral}{"{}inlinee\_\%i"{}}, \mbox{\hyperlink{namespacev8_1_1internal}{i}});}
\DoxyCodeLine{4947     builder.AddExport(\{buffer.begin(), len\}, f);}
\DoxyCodeLine{4948     inlinees.emplace\_back(buffer.begin(), len);}
\DoxyCodeLine{4949   \}}
\DoxyCodeLine{4950 }
\DoxyCodeLine{4951   \textcolor{comment}{// Create main function body.}}
\DoxyCodeLine{4952   \{}
\DoxyCodeLine{4953     uint32\_t declared\_func\_index = num\_functions -\/ 1;}
\DoxyCodeLine{4954     WasmFunctionBuilder* f = functions[declared\_func\_index];}
\DoxyCodeLine{4955     DataRange function\_range = range.split();}
\DoxyCodeLine{4956     BodyGen gen\_body(options, f, function\_signatures, \{\}, \{\}, struct\_types,}
\DoxyCodeLine{4957                      array\_types, strings, \&function\_range);}
\DoxyCodeLine{4958     gen\_body.InitializeNonDefaultableLocals(\&function\_range);}
\DoxyCodeLine{4959     \textcolor{comment}{// Store the call target}}
\DoxyCodeLine{4960     f-\/>EmitWithU32V(kExprLocalGet, 0);}
\DoxyCodeLine{4961     f-\/>EmitWithU32V(kExprGlobalSet, 0);}
\DoxyCodeLine{4962     \textcolor{comment}{// Call inlinee or emit deopt.}}
\DoxyCodeLine{4963     \textcolor{keywordflow}{if} (num\_inlinees == 0) \{}
\DoxyCodeLine{4964       \textcolor{comment}{// If we don't have any inlinees, directly emit the deopt point.}}
\DoxyCodeLine{4965       \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_addae1cc9d8e10a41a85fbd188db4f081}{EmitDeoptAndReturnValues}}(gen\_body, f, target\_sig, target\_sig\_index,}
\DoxyCodeLine{4966                                global\_index, table\_index, use\_table64,}
\DoxyCodeLine{4967                                \&function\_range);}
\DoxyCodeLine{4968     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{4969       \textcolor{comment}{// Otherwise call the "{}outer-\/most"{} inlinee.}}
\DoxyCodeLine{4970       uint32\_t callee\_declared\_index = declared\_func\_index -\/ 1;}
\DoxyCodeLine{4971       \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a965a6586b49189e8ffcea8e0a570923e}{EmitCallAndReturnValues}}(gen\_body, f, functions[callee\_declared\_index],}
\DoxyCodeLine{4972                               table\_index, use\_table64, \&function\_range);}
\DoxyCodeLine{4973     \}}
\DoxyCodeLine{4974 }
\DoxyCodeLine{4975     f-\/>Emit(kExprEnd);}
\DoxyCodeLine{4976     builder.AddExport(\mbox{\hyperlink{namespacev8_1_1base_a00f1f354f310e47ef4694667601d62fb}{base::StaticCharVector}}(\textcolor{stringliteral}{"{}main"{}}), f);}
\DoxyCodeLine{4977   \}}
\DoxyCodeLine{4978 }
\DoxyCodeLine{4979   \textcolor{comment}{// Create call target bodies.}}
\DoxyCodeLine{4980   \textcolor{comment}{// This is done last as we care much less about the content of these}}
\DoxyCodeLine{4981   \textcolor{comment}{// functions, so it's less of an issue if there aren't (m)any random bytes}}
\DoxyCodeLine{4982   \textcolor{comment}{// left.}}
\DoxyCodeLine{4983   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_call\_targets; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{4984     WasmFunctionBuilder* f = functions[\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}];}
\DoxyCodeLine{4985     DataRange function\_range = range.split();}
\DoxyCodeLine{4986     BodyGen gen\_body(options, f, function\_signatures, \{\}, \{\}, struct\_types,}
\DoxyCodeLine{4987                      array\_types, strings, \&function\_range);}
\DoxyCodeLine{4988     \textcolor{keyword}{const} \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a1a17c60bc1e8b8ad11208d7b0d3ec5a9}{FunctionSig}}* \mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}} = f-\/>signature();}
\DoxyCodeLine{4989     base::Vector<const ValueType> target\_return\_types(\mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}}-\/>returns().begin(),}
\DoxyCodeLine{4990                                                       \mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}}-\/>return\_count());}
\DoxyCodeLine{4991     gen\_body.InitializeNonDefaultableLocals(\&function\_range);}
\DoxyCodeLine{4992     gen\_body.Generate(target\_return\_types, \&function\_range);}
\DoxyCodeLine{4993 }
\DoxyCodeLine{4994     f-\/>Emit(kExprEnd);}
\DoxyCodeLine{4995     \textcolor{keyword}{auto} buffer = zone-\/>AllocateVector<\textcolor{keywordtype}{char}>(32);}
\DoxyCodeLine{4996     \textcolor{keywordtype}{size\_t} len = \mbox{\hyperlink{namespacev8_1_1base_a36caaf43a3f7761ae90d699b961f0239}{base::SNPrintF}}(buffer, \textcolor{stringliteral}{"{}callee\_\%i"{}}, \mbox{\hyperlink{namespacev8_1_1internal}{i}});}
\DoxyCodeLine{4997     builder.AddExport(\{buffer.begin(), len\}, f);}
\DoxyCodeLine{4998     callees.emplace\_back(buffer.begin(), len);}
\DoxyCodeLine{4999   \}}
\DoxyCodeLine{5000 }
\DoxyCodeLine{5001   ZoneBuffer buffer\{zone\};}
\DoxyCodeLine{5002   builder.WriteTo(\&buffer);}
\DoxyCodeLine{5003   \textcolor{keywordflow}{return} \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(buffer);}
\DoxyCodeLine{5004 \}}

\end{DoxyCode}


References v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Array\+Type(), CHECK\+\_\+\+EQ, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Create\+Signature(), DCHECK\+\_\+\+EQ, v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Force\+Add\+Signature(), v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Generate\+Types(), v8\+::internal\+::anonymous\+\_\+namespace\{json-\/stringifier.\+cc\}\+::i, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Arrays, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Structs, v8\+::internal\+::wasm\+::k\+No\+Super\+Type, v8\+::internal\+::wasm\+::k\+Wasm\+I16, v8\+::internal\+::wasm\+::k\+Wasm\+I8, v8\+::internal\+::\+Zone\+::\+New(), v8\+::base\+::\+Vector\+Of(), and v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::zone().

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a6936bb2d2d2321245a7f08dd9568ba17_cgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacev8_1_1internal_1_1wasm_1_1fuzzing_aa6e6cd8b36eacefd6741e4de4920aae0}\label{namespacev8_1_1internal_1_1wasm_1_1fuzzing_aa6e6cd8b36eacefd6741e4de4920aae0}} 
\index{v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}!GenerateWasmModuleForInitExpressions@{GenerateWasmModuleForInitExpressions}}
\index{GenerateWasmModuleForInitExpressions@{GenerateWasmModuleForInitExpressions}!v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}}
\doxysubsubsection{\texorpdfstring{GenerateWasmModuleForInitExpressions()}{GenerateWasmModuleForInitExpressions()}}
{\footnotesize\ttfamily \mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$uint8\+\_\+t$>$ v8\+::internal\+::wasm\+::fuzzing\+::\+Generate\+Wasm\+Module\+For\+Init\+Expressions (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classv8_1_1internal_1_1Zone}{Zone}} $\ast$}]{zone,  }\item[{\mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ const uint8\+\_\+t $>$}]{data,  }\item[{\mbox{\hyperlink{namespacev8_1_1internal_a4725962ca3c127eb5871cb47293aee95}{size\+\_\+t}} $\ast$}]{count }\end{DoxyParamCaption})}



Definition at line 4510 of file random-\/module-\/generation.\+cc.


\begin{DoxyCode}{0}
\DoxyCodeLine{4511                                                                \{}
\DoxyCodeLine{4512   \textcolor{comment}{// Don't limit expressions for the initializer expression fuzzer.}}
\DoxyCodeLine{4513   constexpr WasmModuleGenerationOptions options =}
\DoxyCodeLine{4514       WasmModuleGenerationOptions::All();}
\DoxyCodeLine{4515   WasmModuleBuilder builder(zone);}
\DoxyCodeLine{4516 }
\DoxyCodeLine{4517   DataRange module\_range(data);}
\DoxyCodeLine{4518   std::vector<ModuleTypeIndex> function\_signatures;}
\DoxyCodeLine{4519   std::vector<ModuleTypeIndex> array\_types;}
\DoxyCodeLine{4520   std::vector<ModuleTypeIndex> struct\_types;}
\DoxyCodeLine{4521 }
\DoxyCodeLine{4522   \textcolor{keywordtype}{int} num\_globals = 1 + module\_range.get<uint8\_t>() \% (\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a86157651e37b914c574ad221f4f0570c}{kMaxGlobals}} + 1);}
\DoxyCodeLine{4523 }
\DoxyCodeLine{4524   uint8\_t num\_functions = num\_globals;}
\DoxyCodeLine{4525   *count = num\_functions;}
\DoxyCodeLine{4526 }
\DoxyCodeLine{4527   \textcolor{comment}{// We need at least one struct and one array in order to support}}
\DoxyCodeLine{4528   \textcolor{comment}{// WasmInitExpr for abstract types.}}
\DoxyCodeLine{4529   uint8\_t num\_structs = 1 + module\_range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a0715189293751f7b8f6ac34a74057282}{kMaxStructs}};}
\DoxyCodeLine{4530   uint8\_t num\_arrays = 1 + module\_range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_adae57d01cf1790d3aa59bb4ae3f1c2ff}{kMaxArrays}};}
\DoxyCodeLine{4531   \mbox{\hyperlink{namespaceunibrow_a0869a94c1a582a2b47889b990444deb9}{uint16\_t}} num\_types = num\_functions + num\_structs + num\_arrays;}
\DoxyCodeLine{4532 }
\DoxyCodeLine{4533   uint8\_t current\_type\_index = 0;}
\DoxyCodeLine{4534 }
\DoxyCodeLine{4535   \textcolor{comment}{// Add random-\/generated types.}}
\DoxyCodeLine{4536   uint8\_t last\_struct\_type = current\_type\_index + num\_structs;}
\DoxyCodeLine{4537   \textcolor{keywordflow}{for} (; current\_type\_index < last\_struct\_type; current\_type\_index++) \{}
\DoxyCodeLine{4538     ModuleTypeIndex supertype = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a9426d91ec5f89dd5402e6579bd09e9cc}{kNoSuperType}};}
\DoxyCodeLine{4539     uint8\_t num\_fields = module\_range.get<uint8\_t>() \% (\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_aa9bd5a02c183eaf1d7f46a95593fb830}{kMaxStructFields}} + 1);}
\DoxyCodeLine{4540 }
\DoxyCodeLine{4541     uint32\_t existing\_struct\_types = current\_type\_index;}
\DoxyCodeLine{4542     \textcolor{keywordflow}{if} (existing\_struct\_types > 0 \&\& module\_range.get<\textcolor{keywordtype}{bool}>()) \{}
\DoxyCodeLine{4543       supertype =}
\DoxyCodeLine{4544           ModuleTypeIndex\{module\_range.get<uint8\_t>() \% existing\_struct\_types\};}
\DoxyCodeLine{4545       num\_fields += builder.GetStructType(supertype)-\/>field\_count();}
\DoxyCodeLine{4546     \}}
\DoxyCodeLine{4547     \textcolor{comment}{// TODO(403372470): Add support for custom descriptors.}}
\DoxyCodeLine{4548     \textcolor{comment}{// TODO(42204563): Add support for shared structs.}}
\DoxyCodeLine{4549     StructType::Builder struct\_builder(zone, num\_fields, \textcolor{keyword}{false}, \textcolor{keyword}{false});}
\DoxyCodeLine{4550 }
\DoxyCodeLine{4551     \textcolor{comment}{// Add all fields from super type.}}
\DoxyCodeLine{4552     uint32\_t field\_index = 0;}
\DoxyCodeLine{4553     \textcolor{keywordflow}{if} (supertype != \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a9426d91ec5f89dd5402e6579bd09e9cc}{kNoSuperType}}) \{}
\DoxyCodeLine{4554       \textcolor{keyword}{const} StructType* parent = builder.GetStructType(supertype);}
\DoxyCodeLine{4555       \textcolor{keywordflow}{for} (; field\_index < parent-\/>field\_count(); ++field\_index) \{}
\DoxyCodeLine{4556         struct\_builder.AddField(parent-\/>field(field\_index),}
\DoxyCodeLine{4557                                 parent-\/>mutability(field\_index));}
\DoxyCodeLine{4558       \}}
\DoxyCodeLine{4559     \}}
\DoxyCodeLine{4560     \textcolor{keywordflow}{for} (; field\_index < num\_fields; field\_index++) \{}
\DoxyCodeLine{4561       ValueType \mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}} = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_acb818ad2fed6c392a9f1ef8733e69a60}{GetValueTypeHelper}}(}
\DoxyCodeLine{4562           options, \&module\_range, current\_type\_index, current\_type\_index,}
\DoxyCodeLine{4563           \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a99313b90405213121f7481edb723e255a647a68e1171d0782989c18d3493bb5e5}{kIncludeNumericTypes}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a0e16deb97dc9666d3e307e83e4de65ddada2af6c10964e45e0b1864db5059708d}{kIncludePackedTypes}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a1247cb9ab9d903719af07856fb9b8674a7d81e5c0f4f184a3168bc8adcbcd25b1}{kExcludeSomeGenerics}});}
\DoxyCodeLine{4564       \textcolor{comment}{// To prevent huge initializer expressions, limit the existence of}}
\DoxyCodeLine{4565       \textcolor{comment}{// non-\/nullable references to the first 2 struct types (for non-\/inherited}}
\DoxyCodeLine{4566       \textcolor{comment}{// fields).}}
\DoxyCodeLine{4567       \textcolor{keywordflow}{if} (current\_type\_index >= 2 \&\& \mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}}.is\_non\_nullable()) \{}
\DoxyCodeLine{4568         \mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}} = \mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}}.AsNullable();}
\DoxyCodeLine{4569       \}}
\DoxyCodeLine{4570 }
\DoxyCodeLine{4571       \textcolor{keywordtype}{bool} mutability = module\_range.get<\textcolor{keywordtype}{bool}>();}
\DoxyCodeLine{4572       struct\_builder.AddField(\mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}}, mutability);}
\DoxyCodeLine{4573     \}}
\DoxyCodeLine{4574     StructType* struct\_fuz = struct\_builder.Build();}
\DoxyCodeLine{4575     ModuleTypeIndex \mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}} = builder.AddStructType(struct\_fuz, \textcolor{keyword}{false}, supertype);}
\DoxyCodeLine{4576     struct\_types.push\_back(\mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}});}
\DoxyCodeLine{4577   \}}
\DoxyCodeLine{4578 }
\DoxyCodeLine{4579   \textcolor{keywordflow}{for} (; current\_type\_index < num\_structs + num\_arrays; current\_type\_index++) \{}
\DoxyCodeLine{4580     ValueType \mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}} = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_acb818ad2fed6c392a9f1ef8733e69a60}{GetValueTypeHelper}}(}
\DoxyCodeLine{4581         options, \&module\_range, current\_type\_index, current\_type\_index,}
\DoxyCodeLine{4582         \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a99313b90405213121f7481edb723e255a647a68e1171d0782989c18d3493bb5e5}{kIncludeNumericTypes}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a0e16deb97dc9666d3e307e83e4de65ddada2af6c10964e45e0b1864db5059708d}{kIncludePackedTypes}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a1247cb9ab9d903719af07856fb9b8674a7d81e5c0f4f184a3168bc8adcbcd25b1}{kExcludeSomeGenerics}});}
\DoxyCodeLine{4583     ModuleTypeIndex supertype = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a9426d91ec5f89dd5402e6579bd09e9cc}{kNoSuperType}};}
\DoxyCodeLine{4584     \textcolor{keywordflow}{if} (current\_type\_index > last\_struct\_type \&\& module\_range.get<\textcolor{keywordtype}{bool}>()) \{}
\DoxyCodeLine{4585       uint32\_t existing\_array\_types = current\_type\_index -\/ last\_struct\_type;}
\DoxyCodeLine{4586       supertype =}
\DoxyCodeLine{4587           ModuleTypeIndex\{last\_struct\_type +}
\DoxyCodeLine{4588                           (module\_range.get<uint8\_t>() \% existing\_array\_types)\};}
\DoxyCodeLine{4589       \mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}} = builder.GetArrayType(supertype)-\/>element\_type();}
\DoxyCodeLine{4590     \}}
\DoxyCodeLine{4591     ArrayType* array\_fuz = zone-\/>New<ArrayType>(\mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}}, \textcolor{keyword}{true});}
\DoxyCodeLine{4592     ModuleTypeIndex \mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}} = builder.AddArrayType(array\_fuz, \textcolor{keyword}{false}, supertype);}
\DoxyCodeLine{4593     array\_types.push\_back(\mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}});}
\DoxyCodeLine{4594   \}}
\DoxyCodeLine{4595 }
\DoxyCodeLine{4596   \textcolor{comment}{// Choose global types and create function signatures.}}
\DoxyCodeLine{4597   constexpr \textcolor{keywordtype}{bool} kIsFinal = \textcolor{keyword}{true};}
\DoxyCodeLine{4598   std::vector<ValueType> globals;}
\DoxyCodeLine{4599   \textcolor{keywordflow}{for} (; current\_type\_index < num\_types; current\_type\_index++) \{}
\DoxyCodeLine{4600     ValueType return\_type = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_acb818ad2fed6c392a9f1ef8733e69a60}{GetValueTypeHelper}}(}
\DoxyCodeLine{4601         options, \&module\_range, num\_types -\/ num\_globals,}
\DoxyCodeLine{4602         num\_types -\/ num\_globals, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a99313b90405213121f7481edb723e255a647a68e1171d0782989c18d3493bb5e5}{kIncludeNumericTypes}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a0e16deb97dc9666d3e307e83e4de65dda1c361910ffb31ea34a072f17b9047848}{kExcludePackedTypes}},}
\DoxyCodeLine{4603         \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a1247cb9ab9d903719af07856fb9b8674a276b6e4728ab9509fa6a5e6e4f5d6282}{kIncludeAllGenerics}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af2dda83b6bd1509e75e904867a642118a48c9c652e866c200ddb9091f680bf45c}{kExcludeS128}});}
\DoxyCodeLine{4604     globals.push\_back(return\_type);}
\DoxyCodeLine{4605     \textcolor{comment}{// Create a new function signature for each global. These functions will be}}
\DoxyCodeLine{4606     \textcolor{comment}{// used to compare against the initializer value of the global.}}
\DoxyCodeLine{4607     FunctionSig::Builder sig\_builder(zone, 1, 0);}
\DoxyCodeLine{4608     sig\_builder.AddReturn(return\_type);}
\DoxyCodeLine{4609     ModuleTypeIndex signature\_index =}
\DoxyCodeLine{4610         builder.ForceAddSignature(sig\_builder.Get(), kIsFinal);}
\DoxyCodeLine{4611     function\_signatures.push\_back(signature\_index);}
\DoxyCodeLine{4612   \}}
\DoxyCodeLine{4613 }
\DoxyCodeLine{4614   std::vector<WasmFunctionBuilder*> functions;}
\DoxyCodeLine{4615   functions.reserve(num\_functions);}
\DoxyCodeLine{4616   \textcolor{keywordflow}{for} (uint8\_t \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_functions; \mbox{\hyperlink{namespacev8_1_1internal}{i}}++) \{}
\DoxyCodeLine{4617     functions.push\_back(builder.AddFunction(function\_signatures[\mbox{\hyperlink{namespacev8_1_1internal}{i}}]));}
\DoxyCodeLine{4618   \}}
\DoxyCodeLine{4619 }
\DoxyCodeLine{4620   \textcolor{comment}{// Create globals.}}
\DoxyCodeLine{4621   std::vector<uint8\_t> mutable\_globals;}
\DoxyCodeLine{4622   std::vector<WasmInitExpr> init\_exprs;}
\DoxyCodeLine{4623   init\_exprs.reserve(num\_globals);}
\DoxyCodeLine{4624   mutable\_globals.reserve(num\_globals);}
\DoxyCodeLine{4625   \mbox{\hyperlink{src_2base_2logging_8h_aca32614b4d2aea7dd9abdeb222bf02f3}{CHECK\_EQ}}(globals.size(), num\_globals);}
\DoxyCodeLine{4626   uint64\_t mutabilities = module\_range.get<uint64\_t>();}
\DoxyCodeLine{4627   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_globals; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{4628     ValueType \mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}} = globals[\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}];}
\DoxyCodeLine{4629     \textcolor{comment}{// 50\% of globals are immutable.}}
\DoxyCodeLine{4630     \textcolor{keyword}{const} \textcolor{keywordtype}{bool} mutability = mutabilities \& 1;}
\DoxyCodeLine{4631     mutabilities >>= 1;}
\DoxyCodeLine{4632     WasmInitExpr init\_expr = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a0156834d880d64a7a80371af3528ebda}{GenerateInitExpr}}(}
\DoxyCodeLine{4633         zone, module\_range, \&builder, \mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}}, struct\_types, array\_types, 0);}
\DoxyCodeLine{4634     init\_exprs.push\_back(init\_expr);}
\DoxyCodeLine{4635     \textcolor{keyword}{auto} buffer = zone-\/>AllocateVector<\textcolor{keywordtype}{char}>(8);}
\DoxyCodeLine{4636     \textcolor{keywordtype}{size\_t} len = \mbox{\hyperlink{namespacev8_1_1base_a36caaf43a3f7761ae90d699b961f0239}{base::SNPrintF}}(buffer, \textcolor{stringliteral}{"{}g\%i"{}}, \mbox{\hyperlink{namespacev8_1_1internal}{i}});}
\DoxyCodeLine{4637     builder.AddExportedGlobal(\mbox{\hyperlink{namespacev8_1_1internal_1_1tracing_a96000282e12b2483531025283d63154d}{type}}, mutability, init\_expr,}
\DoxyCodeLine{4638                               \{buffer.begin(), len\});}
\DoxyCodeLine{4639     \textcolor{keywordflow}{if} (mutability) mutable\_globals.push\_back(\textcolor{keyword}{static\_cast<}uint8\_t\textcolor{keyword}{>}(\mbox{\hyperlink{namespacev8_1_1internal}{i}}));}
\DoxyCodeLine{4640   \}}
\DoxyCodeLine{4641 }
\DoxyCodeLine{4642   \textcolor{comment}{// Create functions containing the initializer of each global as its function}}
\DoxyCodeLine{4643   \textcolor{comment}{// body.}}
\DoxyCodeLine{4644   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_functions; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{4645     WasmFunctionBuilder* f = functions[\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}];}
\DoxyCodeLine{4646     f-\/>EmitFromInitializerExpression(init\_exprs[\mbox{\hyperlink{namespacev8_1_1internal}{i}}]);}
\DoxyCodeLine{4647     \textcolor{keyword}{auto} buffer = zone-\/>AllocateVector<\textcolor{keywordtype}{char}>(8);}
\DoxyCodeLine{4648     \textcolor{keywordtype}{size\_t} len = \mbox{\hyperlink{namespacev8_1_1base_a36caaf43a3f7761ae90d699b961f0239}{base::SNPrintF}}(buffer, \textcolor{stringliteral}{"{}f\%i"{}}, \mbox{\hyperlink{namespacev8_1_1internal}{i}});}
\DoxyCodeLine{4649     builder.AddExport(\{buffer.begin(), len\}, f);}
\DoxyCodeLine{4650   \}}
\DoxyCodeLine{4651 }
\DoxyCodeLine{4652   ZoneBuffer buffer\{zone\};}
\DoxyCodeLine{4653   builder.WriteTo(\&buffer);}
\DoxyCodeLine{4654   \textcolor{keywordflow}{return} \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(buffer);}
\DoxyCodeLine{4655 \}}

\end{DoxyCode}


References v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Array\+Type(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Export(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Exported\+Global(), v8\+::internal\+::wasm\+::\+Struct\+Type\+Base\+::\+Builder\+Impl$<$ Subclass, Value\+Type\+Subclass $>$\+::\+Add\+Field(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Function(), v8\+::internal\+::\+Signature\+Builder$<$ Sig\+T, T $>$\+::\+Add\+Return(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Struct\+Type(), v8\+::internal\+::\+Zone\+::\+Allocate\+Vector(), v8\+::internal\+::wasm\+::\+Struct\+Type\+Base\+::\+Builder\+Impl$<$ Subclass, Value\+Type\+Subclass $>$\+::\+Build(), CHECK\+\_\+\+EQ, v8\+::internal\+::wasm\+::\+Array\+Type\+::element\+\_\+type(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit\+From\+Initializer\+Expression(), v8\+::internal\+::wasm\+::\+Struct\+Type\+::field(), v8\+::internal\+::wasm\+::\+Struct\+Type\+Base\+::field\+\_\+count(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Force\+Add\+Signature(), v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Generate\+Init\+Expr(), v8\+::internal\+::\+Signature\+Builder$<$ Sig\+T, T $>$\+::\+Get(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Get\+Array\+Type(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Get\+Struct\+Type(), v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Get\+Value\+Type\+Helper(), v8\+::internal\+::anonymous\+\_\+namespace\{json-\/stringifier.\+cc\}\+::i, v8\+::internal\+::index, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Exclude\+Packed\+Types, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Exclude\+S128, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Exclude\+Some\+Generics, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Include\+All\+Generics, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Include\+Numeric\+Types, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Include\+Packed\+Types, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Arrays, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Globals, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Struct\+Fields, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Structs, v8\+::internal\+::wasm\+::k\+No\+Super\+Type, v8\+::internal\+::wasm\+::\+Struct\+Type\+Base\+::mutability(), v8\+::internal\+::\+Zone\+::\+New(), v8\+::base\+::\+SNPrint\+F(), v8\+::internal\+::tracing\+::type, v8\+::base\+::\+Vector\+Of(), and v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Write\+To().

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{namespacev8_1_1internal_1_1wasm_1_1fuzzing_aa6e6cd8b36eacefd6741e4de4920aae0_cgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a11b6131999053f1b730541b3534bfcd2}\label{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a11b6131999053f1b730541b3534bfcd2}} 
\index{v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}!GenerateWasmModuleForRevec@{GenerateWasmModuleForRevec}}
\index{GenerateWasmModuleForRevec@{GenerateWasmModuleForRevec}!v8::internal::wasm::fuzzing@{v8::internal::wasm::fuzzing}}
\doxysubsubsection{\texorpdfstring{GenerateWasmModuleForRevec()}{GenerateWasmModuleForRevec()}}
{\footnotesize\ttfamily \mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$uint8\+\_\+t$>$ v8\+::internal\+::wasm\+::fuzzing\+::\+Generate\+Wasm\+Module\+For\+Revec (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{classv8_1_1internal_1_1Zone}{Zone}} $\ast$}]{zone,  }\item[{\mbox{\hyperlink{classv8_1_1base_1_1Vector}{base\+::\+Vector}}$<$ const uint8\+\_\+t $>$}]{data }\end{DoxyParamCaption})}



Definition at line 5006 of file random-\/module-\/generation.\+cc.


\begin{DoxyCode}{0}
\DoxyCodeLine{5007                                                 \{}
\DoxyCodeLine{5008   constexpr WasmModuleGenerationOptions options = \{}
\DoxyCodeLine{5009       \{WasmModuleGenerationOption::kGenerateSIMD\}\};}
\DoxyCodeLine{5010   WasmModuleBuilder builder(zone);}
\DoxyCodeLine{5011 }
\DoxyCodeLine{5012   \textcolor{comment}{// Split input data in two parts:}}
\DoxyCodeLine{5013   \textcolor{comment}{// -\/ One for the "{}module"{} (types, globals, ..)}}
\DoxyCodeLine{5014   \textcolor{comment}{// -\/ One for all the function bodies}}
\DoxyCodeLine{5015   \textcolor{comment}{// This prevents using a too large portion on the module resulting in}}
\DoxyCodeLine{5016   \textcolor{comment}{// uninteresting function bodies.}}
\DoxyCodeLine{5017   DataRange module\_range(data);}
\DoxyCodeLine{5018   DataRange functions\_range = module\_range.split();}
\DoxyCodeLine{5019   std::vector<ModuleTypeIndex> function\_signatures;}
\DoxyCodeLine{5020 }
\DoxyCodeLine{5021   \textcolor{comment}{// At least 1 function is needed.}}
\DoxyCodeLine{5022   \textcolor{keywordtype}{int} max\_num\_functions = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a09efd81c34c8e231e0d6195e2e777c46}{MaxNumOfFunctions}}();}
\DoxyCodeLine{5023   \mbox{\hyperlink{src_2base_2logging_8h_a1c7c9b7f14b9a33ea69cbe4578016a19}{CHECK\_GE}}(max\_num\_functions, 1);}
\DoxyCodeLine{5024   uint8\_t num\_functions = 1 + (module\_range.get<uint8\_t>() \% max\_num\_functions);}
\DoxyCodeLine{5025 }
\DoxyCodeLine{5026   constexpr uint8\_t kNumStructs = 0;}
\DoxyCodeLine{5027   constexpr uint8\_t kNumArrays = 0;}
\DoxyCodeLine{5028   constexpr \mbox{\hyperlink{namespaceunibrow_a0869a94c1a582a2b47889b990444deb9}{uint16\_t}} \mbox{\hyperlink{namespacev8_1_1internal_abb767b639fb9b3ebabe15c8e91e99210a28541a5b96138a94a09ea59fc723dc9b}{kNumTypes}} = kNumStructs + kNumArrays;}
\DoxyCodeLine{5029   std::vector<ModuleTypeIndex> array\_types;}
\DoxyCodeLine{5030   std::vector<ModuleTypeIndex> struct\_types;}
\DoxyCodeLine{5031 }
\DoxyCodeLine{5032   uint8\_t num\_signatures = num\_functions;}
\DoxyCodeLine{5033   ModuleGen gen\_module(zone, options, \&builder, \&module\_range, num\_functions,}
\DoxyCodeLine{5034                        kNumStructs, kNumArrays, num\_signatures);}
\DoxyCodeLine{5035 }
\DoxyCodeLine{5036   gen\_module.GenerateRandomMemories();}
\DoxyCodeLine{5037 }
\DoxyCodeLine{5038   \textcolor{comment}{// We keep the signature for the first (main) function constant.}}
\DoxyCodeLine{5039   constexpr \textcolor{keywordtype}{bool} kIsFinal = \textcolor{keyword}{true};}
\DoxyCodeLine{5040   \textcolor{keyword}{auto} kMainFnSig = FixedSizeSignature<ValueType>::Returns(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}}).Params(}
\DoxyCodeLine{5041       \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}}, \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}});}
\DoxyCodeLine{5042   function\_signatures.push\_back(}
\DoxyCodeLine{5043       builder.ForceAddSignature(\&kMainFnSig, kIsFinal));}
\DoxyCodeLine{5044 }
\DoxyCodeLine{5045   \textcolor{comment}{// Other function signatures: return void with random params.}}
\DoxyCodeLine{5046   constexpr base::Vector<const ValueType> kNoReturnType;}
\DoxyCodeLine{5047   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 1; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_signatures; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{5048     \textcolor{keyword}{const} \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a1a17c60bc1e8b8ad11208d7b0d3ec5a9}{FunctionSig}}* function\_sig = \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a1724a388014541082690d4718b8e4def}{CreateSignature}}(}
\DoxyCodeLine{5049         builder.zone(),}
\DoxyCodeLine{5050         \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af9bd96390b0b3e34a32b1e3e307a2ce8}{GenerateTypes}}(options, \&module\_range, kNumTypes)),}
\DoxyCodeLine{5051         kNoReturnType);}
\DoxyCodeLine{5052     function\_signatures.push\_back(}
\DoxyCodeLine{5053         builder.ForceAddSignature(function\_sig, kIsFinal));}
\DoxyCodeLine{5054   \}}
\DoxyCodeLine{5055 }
\DoxyCodeLine{5056   \textcolor{comment}{// Add exceptions.}}
\DoxyCodeLine{5057   \textcolor{keywordtype}{int} num\_exceptions = 1 + (module\_range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_af71b678ded0cb5aca0dd86c9b4f038c3}{kMaxExceptions}});}
\DoxyCodeLine{5058   gen\_module.GenerateRandomExceptions(num\_exceptions);}
\DoxyCodeLine{5059 }
\DoxyCodeLine{5060   StringImports strings = StringImports();}
\DoxyCodeLine{5061 }
\DoxyCodeLine{5062   \textcolor{comment}{// Generate function declarations before tables. This will be needed once we}}
\DoxyCodeLine{5063   \textcolor{comment}{// have typed-\/function tables.}}
\DoxyCodeLine{5064   std::vector<WasmFunctionBuilder*> functions;}
\DoxyCodeLine{5065   functions.reserve(num\_functions);}
\DoxyCodeLine{5066   \textcolor{keywordflow}{for} (uint8\_t \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_functions; \mbox{\hyperlink{namespacev8_1_1internal}{i}}++) \{}
\DoxyCodeLine{5067     functions.push\_back(builder.AddFunction(function\_signatures[\mbox{\hyperlink{namespacev8_1_1internal}{i}}]));}
\DoxyCodeLine{5068   \}}
\DoxyCodeLine{5069 }
\DoxyCodeLine{5070   gen\_module.GenerateRandomTables(array\_types, struct\_types);}
\DoxyCodeLine{5071 }
\DoxyCodeLine{5072   \textcolor{comment}{// Add globals.}}
\DoxyCodeLine{5073   \textcolor{keyword}{auto} [globals, mutable\_globals] =}
\DoxyCodeLine{5074       gen\_module.GenerateRandomGlobals(array\_types, struct\_types);}
\DoxyCodeLine{5075 }
\DoxyCodeLine{5076   \textcolor{comment}{// Add passive data segments.}}
\DoxyCodeLine{5077   \textcolor{keywordtype}{int} num\_data\_segments = module\_range.get<uint8\_t>() \% \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a2f120e601c51bf84c21c1072594c3b03}{kMaxPassiveDataSegments}};}
\DoxyCodeLine{5078   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_data\_segments; \mbox{\hyperlink{namespacev8_1_1internal}{i}}++) \{}
\DoxyCodeLine{5079     \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_1_1fuzzing_1_1anonymous__namespace_02random-module-generation_8cc_03_a66f258d156112784e0c4175bedb6db8a}{GeneratePassiveDataSegment}}(\&module\_range, \&builder);}
\DoxyCodeLine{5080   \}}
\DoxyCodeLine{5081 }
\DoxyCodeLine{5082   \textcolor{comment}{// Generate function bodies.}}
\DoxyCodeLine{5083   \textcolor{comment}{// Revec uses two contiguous S128Store instructions as seeds, the two}}
\DoxyCodeLine{5084   \textcolor{comment}{// instructions share the same memory\_index/alignment/index, the values to be}}
\DoxyCodeLine{5085   \textcolor{comment}{// stored should be generated from the same DataRange. The second offset is 16}}
\DoxyCodeLine{5086   \textcolor{comment}{// bytes larger than the first offset.}}
\DoxyCodeLine{5087   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} \mbox{\hyperlink{namespacev8_1_1internal}{i}} = 0; \mbox{\hyperlink{namespacev8_1_1internal}{i}} < num\_functions; ++\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}) \{}
\DoxyCodeLine{5088     WasmFunctionBuilder* f = functions[\mbox{\hyperlink{namespacev8_1_1internal_1_1anonymous__namespace_02json-stringifier_8cc_03_ad86b3cf21e19e97ce484f32b894d548c}{i}}];}
\DoxyCodeLine{5089     \textcolor{comment}{// On the last function don't split the DataRange but just use the}}
\DoxyCodeLine{5090     \textcolor{comment}{// existing DataRange.}}
\DoxyCodeLine{5091     DataRange function\_range = \mbox{\hyperlink{namespacev8_1_1internal}{i}} != num\_functions -\/ 1}
\DoxyCodeLine{5092                                    ? functions\_range.split()}
\DoxyCodeLine{5093                                    : std::move(functions\_range);}
\DoxyCodeLine{5094     BodyGen gen\_body(options, f, function\_signatures, globals, mutable\_globals,}
\DoxyCodeLine{5095                      struct\_types, array\_types, strings, \&function\_range);}
\DoxyCodeLine{5096     \textcolor{keyword}{const} \mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a1a17c60bc1e8b8ad11208d7b0d3ec5a9}{FunctionSig}}* \mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}} = f-\/>signature();}
\DoxyCodeLine{5097     base::Vector<const ValueType> return\_types(\mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}}-\/>returns().begin(),}
\DoxyCodeLine{5098                                                \mbox{\hyperlink{namespacev8_1_1internal_a6135f0ef57de8d381e3225f6659c617a}{sig}}-\/>return\_count());}
\DoxyCodeLine{5099     gen\_body.InitializeNonDefaultableLocals(\&function\_range);}
\DoxyCodeLine{5100 }
\DoxyCodeLine{5101     \textcolor{comment}{// Atomic operations need to be aligned exactly to their max alignment.}}
\DoxyCodeLine{5102     \textcolor{keyword}{const} uint8\_t align = function\_range.getPseudoRandom<uint8\_t>() \% (4 + 1);}
\DoxyCodeLine{5103 }
\DoxyCodeLine{5104     \textcolor{comment}{// Only memory0 is supported in revec for now.}}
\DoxyCodeLine{5105     constexpr uint8\_t kMemoryIndex0 = 0;}
\DoxyCodeLine{5106 }
\DoxyCodeLine{5107     uint64\_t offset = function\_range.get<\mbox{\hyperlink{namespaceunibrow_a0869a94c1a582a2b47889b990444deb9}{uint16\_t}}>();}
\DoxyCodeLine{5108     \textcolor{comment}{// With a 1/256 chance generate potentially very large offsets.}}
\DoxyCodeLine{5109     \textcolor{keywordflow}{if} ((offset \& 0xff) == 0xff) \{}
\DoxyCodeLine{5110       offset = f-\/>builder()-\/>IsMemory64(kMemoryIndex0)}
\DoxyCodeLine{5111                    ? function\_range.getPseudoRandom<uint64\_t>() \& 0x1ffffffff}
\DoxyCodeLine{5112                    : function\_range.getPseudoRandom<uint32\_t>();}
\DoxyCodeLine{5113     \}}
\DoxyCodeLine{5114 }
\DoxyCodeLine{5115     \textcolor{keyword}{auto} first\_data = function\_range.split();}
\DoxyCodeLine{5116 }
\DoxyCodeLine{5117     \textcolor{comment}{// === The first store. ===}}
\DoxyCodeLine{5118     \textcolor{comment}{// Generate the index.}}
\DoxyCodeLine{5119     uint32\_t \mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}};}
\DoxyCodeLine{5120     \textcolor{keywordflow}{if} (f-\/>builder()-\/>IsMemory64(kMemoryIndex0)) \{}
\DoxyCodeLine{5121       \mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}} = f-\/>AddLocal(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_aee8b7f805fa662ae4ed159f8072bea5f}{kWasmI64}});}
\DoxyCodeLine{5122       gen\_body.Generate<\mbox{\hyperlink{namespacev8_1_1internal_abb767b639fb9b3ebabe15c8e91e99210a6601e7b0f7c0f03d9ffa9f222c82e6a0}{kI64}}>(\&first\_data);}
\DoxyCodeLine{5123     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{5124       \mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}} = f-\/>AddLocal(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_a7b893808fadaa287f225d7209d2d36c6}{kWasmI32}});}
\DoxyCodeLine{5125       gen\_body.Generate<\mbox{\hyperlink{namespacev8_1_1internal_abb767b639fb9b3ebabe15c8e91e99210a0a0ecdb4eded286c722877578774a293}{kI32}}>(\&first\_data);}
\DoxyCodeLine{5126     \}}
\DoxyCodeLine{5127     f-\/>EmitTeeLocal(\mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}});}
\DoxyCodeLine{5128 }
\DoxyCodeLine{5129     \textcolor{comment}{// Generate the S128 value to be stored.}}
\DoxyCodeLine{5130     \textcolor{comment}{// With 50\% chance generated from the same sequence.}}
\DoxyCodeLine{5131     DataRange store2\_range = function\_range.get<\textcolor{keywordtype}{bool}>()}
\DoxyCodeLine{5132                                  ? function\_range.clone()}
\DoxyCodeLine{5133                                  : function\_range.split();}
\DoxyCodeLine{5134 }
\DoxyCodeLine{5135     gen\_body.Generate<\mbox{\hyperlink{namespacev8_1_1internal_abb767b639fb9b3ebabe15c8e91e99210af99a6cf928bc2257d654d6301969318c}{kS128}}>(\&function\_range);}
\DoxyCodeLine{5136 }
\DoxyCodeLine{5137     \textcolor{comment}{// Format of the instruction (supports multi-\/memory):}}
\DoxyCodeLine{5138     \textcolor{comment}{// memory\_op (align | 0x40) memory\_index offset}}
\DoxyCodeLine{5139     f-\/>EmitWithPrefix(kExprS128StoreMem);}
\DoxyCodeLine{5140     f-\/>EmitU32V(align | 0x40);}
\DoxyCodeLine{5141     f-\/>EmitU32V(kMemoryIndex0);}
\DoxyCodeLine{5142     f-\/>EmitU64V(offset);}
\DoxyCodeLine{5143 }
\DoxyCodeLine{5144     \textcolor{comment}{// === The second store. ===}}
\DoxyCodeLine{5145     \textcolor{comment}{// Share the same index, value generated from same}}
\DoxyCodeLine{5146     \textcolor{comment}{// DataRange and offset is 16 larger.}}
\DoxyCodeLine{5147     f-\/>EmitGetLocal(\mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}});}
\DoxyCodeLine{5148     gen\_body.Generate<\mbox{\hyperlink{namespacev8_1_1internal_abb767b639fb9b3ebabe15c8e91e99210af99a6cf928bc2257d654d6301969318c}{kS128}}>(\&store2\_range);}
\DoxyCodeLine{5149 }
\DoxyCodeLine{5150     f-\/>EmitWithPrefix(kExprS128StoreMem);}
\DoxyCodeLine{5151     f-\/>EmitU32V(align | 0x40);}
\DoxyCodeLine{5152     f-\/>EmitU32V(kMemoryIndex0);}
\DoxyCodeLine{5153 }
\DoxyCodeLine{5154     uint64\_t offset2;}
\DoxyCodeLine{5155     \textcolor{comment}{// offset + 16 shouldn't exceed the 32-\/bit range.}}
\DoxyCodeLine{5156     \textcolor{keywordflow}{if} (!f-\/>builder()-\/>IsMemory64(kMemoryIndex0) \&\&}
\DoxyCodeLine{5157         offset + 16 >= std::numeric\_limits<uint32\_t>::max()) \{}
\DoxyCodeLine{5158       offset2 = offset -\/ 16;}
\DoxyCodeLine{5159     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{5160       offset2 = offset + 16;}
\DoxyCodeLine{5161     \}}
\DoxyCodeLine{5162     f-\/>EmitU64V(offset2);}
\DoxyCodeLine{5163 }
\DoxyCodeLine{5164     \textcolor{comment}{// int32\_t main(int32\_t, int32\_t, int32\_t)}}
\DoxyCodeLine{5165     \textcolor{comment}{// S128 a = load(index + offset)}}
\DoxyCodeLine{5166     \textcolor{comment}{// S128 b = load(index + offset2)}}
\DoxyCodeLine{5167     \textcolor{comment}{// S128 c = a \string^ b}}
\DoxyCodeLine{5168     \textcolor{comment}{// return lane(c, 0) \string^ lane(c, 1) \string^ lane(c, 2) \string^ lane(c, 3)}}
\DoxyCodeLine{5169     \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespacev8_1_1internal}{i}} == 0) \{}
\DoxyCodeLine{5170       \textcolor{comment}{// a = load(index + offset)}}
\DoxyCodeLine{5171       f-\/>EmitGetLocal(\mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}});}
\DoxyCodeLine{5172       f-\/>EmitWithPrefix(kExprS128LoadMem);}
\DoxyCodeLine{5173       f-\/>EmitU32V(align | 0x40);}
\DoxyCodeLine{5174       f-\/>EmitU32V(kMemoryIndex0);}
\DoxyCodeLine{5175       f-\/>EmitU64V(offset);}
\DoxyCodeLine{5176 }
\DoxyCodeLine{5177       \textcolor{comment}{// b = load(index + offset2)}}
\DoxyCodeLine{5178       f-\/>EmitGetLocal(\mbox{\hyperlink{namespacev8_1_1internal_a0cfab207d565dcf62ebf50f3987e05de}{index}});}
\DoxyCodeLine{5179       f-\/>EmitWithPrefix(kExprS128LoadMem);}
\DoxyCodeLine{5180       f-\/>EmitU32V(align | 0x40);}
\DoxyCodeLine{5181       f-\/>EmitU32V(kMemoryIndex0);}
\DoxyCodeLine{5182       f-\/>EmitU64V(offset2);}
\DoxyCodeLine{5183 }
\DoxyCodeLine{5184       \textcolor{comment}{// c = a \string^ b}}
\DoxyCodeLine{5185       f-\/>EmitWithPrefix(kExprS128Xor);}
\DoxyCodeLine{5186 }
\DoxyCodeLine{5187       uint32\_t xor\_result = f-\/>AddLocal(\mbox{\hyperlink{namespacev8_1_1internal_1_1wasm_adef3c09b05397b61ad793d7c0bdf9e3b}{kWasmS128}});}
\DoxyCodeLine{5188       f-\/>EmitTeeLocal(xor\_result);}
\DoxyCodeLine{5189       f-\/>EmitWithPrefix(kExprI32x4ExtractLane);}
\DoxyCodeLine{5190       f-\/>EmitByte(0);}
\DoxyCodeLine{5191 }
\DoxyCodeLine{5192       f-\/>EmitGetLocal(xor\_result);}
\DoxyCodeLine{5193       f-\/>EmitWithPrefix(kExprI32x4ExtractLane);}
\DoxyCodeLine{5194       f-\/>EmitByte(1);}
\DoxyCodeLine{5195 }
\DoxyCodeLine{5196       \textcolor{comment}{// lane(c, 0) \string^ lane(c, 1)}}
\DoxyCodeLine{5197       f-\/>Emit(kExprI32Xor);}
\DoxyCodeLine{5198 }
\DoxyCodeLine{5199       f-\/>EmitGetLocal(xor\_result);}
\DoxyCodeLine{5200       f-\/>EmitWithPrefix(kExprI32x4ExtractLane);}
\DoxyCodeLine{5201       f-\/>EmitByte(2);}
\DoxyCodeLine{5202 }
\DoxyCodeLine{5203       f-\/>EmitGetLocal(xor\_result);}
\DoxyCodeLine{5204       f-\/>EmitWithPrefix(kExprI32x4ExtractLane);}
\DoxyCodeLine{5205       f-\/>EmitByte(3);}
\DoxyCodeLine{5206 }
\DoxyCodeLine{5207       \textcolor{comment}{// lane(c, 2) \string^ lane(c, 3)}}
\DoxyCodeLine{5208       f-\/>Emit(kExprI32Xor);}
\DoxyCodeLine{5209 }
\DoxyCodeLine{5210       \textcolor{comment}{// lane(c, 0) \string^ lane(c, 1) \string^ lane(c, 2) \string^ lane(c, 3)}}
\DoxyCodeLine{5211       f-\/>Emit(kExprI32Xor);}
\DoxyCodeLine{5212     \}}
\DoxyCodeLine{5213 }
\DoxyCodeLine{5214     f-\/>Emit(kExprEnd);}
\DoxyCodeLine{5215     \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespacev8_1_1internal}{i}} == 0) builder.AddExport(\mbox{\hyperlink{namespacev8_1_1base_aaa0a202e5ad0d494cc88496b8fafa571}{base::CStrVector}}(\textcolor{stringliteral}{"{}main"{}}), f);}
\DoxyCodeLine{5216   \}}
\DoxyCodeLine{5217 }
\DoxyCodeLine{5218   ZoneBuffer buffer\{zone\};}
\DoxyCodeLine{5219   builder.WriteTo(\&buffer);}
\DoxyCodeLine{5220   \textcolor{keywordflow}{return} \mbox{\hyperlink{namespacev8_1_1base_a5bfc65f27076e49eb7752a4fb4d45acb}{base::VectorOf}}(buffer);}
\DoxyCodeLine{5221 \}}

\end{DoxyCode}


References v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Export(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Add\+Function(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Add\+Local(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::builder(), CHECK\+\_\+\+GE, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Create\+Signature(), v8\+::base\+::\+CStr\+Vector(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit\+Byte(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit\+Get\+Local(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit\+Tee\+Local(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit\+U32\+V(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit\+U64\+V(), v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::\+Emit\+With\+Prefix(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Force\+Add\+Signature(), v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Generate\+Passive\+Data\+Segment(), v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Generate\+Types(), v8\+::internal\+::anonymous\+\_\+namespace\{json-\/stringifier.\+cc\}\+::i, v8\+::internal\+::index, v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Is\+Memory64(), v8\+::internal\+::k\+I32, v8\+::internal\+::k\+I64, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Exceptions, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::k\+Max\+Passive\+Data\+Segments, v8\+::internal\+::k\+Num\+Types, v8\+::internal\+::k\+S128, v8\+::internal\+::wasm\+::k\+Wasm\+I32, v8\+::internal\+::wasm\+::k\+Wasm\+I64, v8\+::internal\+::wasm\+::k\+Wasm\+S128, v8\+::internal\+::wasm\+::fuzzing\+::anonymous\+\_\+namespace\{random-\/module-\/generation.\+cc\}\+::\+Max\+Num\+Of\+Functions(), v8\+::internal\+::\+Fixed\+Size\+Signature$<$ T, k\+Num\+Returns, k\+Num\+Params $>$\+::\+Params(), v8\+::internal\+::sig, v8\+::internal\+::wasm\+::\+Wasm\+Function\+Builder\+::signature(), v8\+::base\+::\+Vector\+Of(), v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::\+Write\+To(), and v8\+::internal\+::wasm\+::\+Wasm\+Module\+Builder\+::zone().

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{namespacev8_1_1internal_1_1wasm_1_1fuzzing_a11b6131999053f1b730541b3534bfcd2_cgraph}
\end{center}
\end{figure}
