<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>V8 Project: /mnt/V8SourceCode/src/sandbox/sandbox.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">V8 Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('sandbox_8cc_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">sandbox.cc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="sandbox_8cc.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// Copyright 2021 the V8 project authors. All rights reserved.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// found in the LICENSE file.</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; </div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="sandbox_8h.html">src/sandbox/sandbox.h</a>&quot;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; </div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="v8-internal_8h.html">include/v8-internal.h</a>&quot;</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="bits_8h.html">src/base/bits.h</a>&quot;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="bounded-page-allocator_8h.html">src/base/bounded-page-allocator.h</a>&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="cpu_8h.html">src/base/cpu.h</a>&quot;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="emulated-virtual-address-subspace_8h.html">src/base/emulated-virtual-address-subspace.h</a>&quot;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="lazy-instance_8h.html">src/base/lazy-instance.h</a>&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="sys-info_8h.html">src/base/sys-info.h</a>&quot;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="random-number-generator_8h.html">src/base/utils/random-number-generator.h</a>&quot;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="virtual-address-space-page-allocator_8h.html">src/base/virtual-address-space-page-allocator.h</a>&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="virtual-address-space_8h.html">src/base/virtual-address-space.h</a>&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="flags_2flags_8h.html">src/flags/flags.h</a>&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="hardware-support_8h.html">src/sandbox/hardware-support.h</a>&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="sandboxed-pointer_8h.html">src/sandbox/sandboxed-pointer.h</a>&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="src_2utils_2allocation_8h.html">src/utils/allocation.h</a>&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160; </div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacev8.html">v8</a> {</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacev8_1_1internal.html#a5031451934208565c827c86d9eb86c5a">internal</a> {</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160; </div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#ifdef V8_ENABLE_SANDBOX</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160; </div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keywordtype">bool</span> Sandbox::first_four_gb_of_address_space_are_reserved_ = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160; </div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#ifdef V8_COMPRESS_POINTERS_IN_MULTIPLE_CAGES</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;thread_local Sandbox* Sandbox::current_ = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// static</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;Sandbox* Sandbox::current_non_inlined() { <span class="keywordflow">return</span> current_; }</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">// static</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keywordtype">void</span> Sandbox::set_current_non_inlined(Sandbox* sandbox) { current_ = sandbox; }</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#endif  </span><span class="comment">// V8_COMPRESS_POINTERS_IN_MULTIPLE_CAGES</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160; </div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;Sandbox* Sandbox::default_sandbox_ = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">// Best-effort function to determine the approximate size of the virtual</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">// address space that can be addressed by this process. Used to determine</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">// appropriate sandbox size and placement.</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">// The value returned by this function will always be a power of two.</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keyword">static</span> <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> DetermineAddressSpaceLimit() {</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#ifndef V8_TARGET_ARCH_64_BIT</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#error Unsupported target architecture.</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <span class="comment">// Assume 48 bits by default, which seems to be the most common configuration.</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  constexpr <span class="keywordtype">unsigned</span> kDefaultVirtualAddressBits = 48;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="comment">// 36 bits should realistically be the lowest value we could ever see.</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  constexpr <span class="keywordtype">unsigned</span> kMinVirtualAddressBits = 36;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  constexpr <span class="keywordtype">unsigned</span> kMaxVirtualAddressBits = 64;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160; </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keywordtype">unsigned</span> hardware_virtual_address_bits = kDefaultVirtualAddressBits;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#if defined(V8_TARGET_ARCH_X64)</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  base::CPU cpu;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keywordflow">if</span> (cpu.exposes_num_virtual_address_bits()) {</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    hardware_virtual_address_bits = cpu.num_virtual_address_bits();</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  }</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#endif  </span><span class="comment">// V8_TARGET_ARCH_X64</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor">#if defined(V8_TARGET_ARCH_ARM64) &amp;&amp; defined(V8_TARGET_OS_ANDROID)</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="comment">// On Arm64 Android assume a 40-bit virtual address space (39 bits for</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="comment">// userspace and kernel each) as that appears to be the most common</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <span class="comment">// configuration and there seems to be no easy way to retrieve the actual</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="comment">// number of virtual address bits from the CPU in userspace.</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  hardware_virtual_address_bits = 40;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="preprocessor">#elif defined(V8_TARGET_OS_IOS)</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="comment">// On iOS, we only get 64 GB of userspace virtual address space even with the</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="comment">// &quot;jumbo&quot; extended virtual addressing entitlement, so assume a 37-bit virtual</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  <span class="comment">// address space (36 bits for userspace and kernel each). Ensure that this</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="comment">// results in `hardware_virtual_address_bits` being at least the minimum (36)</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="comment">// otherwise we will override it with the default value (48) incorrectly.</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  hardware_virtual_address_bits = 37;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="comment">// Assume virtual address space is split 50/50 between userspace and kernel.</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  hardware_virtual_address_bits -= 1;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160; </div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <span class="comment">// Check if there is a software-imposed limits on the size of the address</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="comment">// space. For example, older Windows versions limit the address space to 8TB:</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="comment">// https://learn.microsoft.com/en-us/windows/win32/memory/memory-limits-for-windows-releases).</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> software_limit = <a class="code" href="classv8_1_1base_1_1SysInfo.html#a5bfbc11d20bf73ed9cb8986c17d0ee4e">base::SysInfo::AddressSpaceEnd</a>();</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="comment">// Compute the next power of two that is larger or equal to the limit.</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keywordtype">unsigned</span> software_virtual_address_bits =</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;      64 - <a class="code" href="namespacev8_1_1base_1_1bits.html#a480e67428223e5edf488b15427c06d77">base::bits::CountLeadingZeros</a>(software_limit - 1);</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160; </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="comment">// The available address space is the smaller of the two limits.</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="keywordtype">unsigned</span> virtual_address_bits =</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;      std::min(hardware_virtual_address_bits, software_virtual_address_bits);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="comment">// Guard against nonsensical values.</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordflow">if</span> (virtual_address_bits &lt; kMinVirtualAddressBits ||</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;      virtual_address_bits &gt; kMaxVirtualAddressBits) {</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    virtual_address_bits = kDefaultVirtualAddressBits;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  }</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160; </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordflow">return</span> 1ULL &lt;&lt; virtual_address_bits;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160; </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="keywordtype">void</span> Sandbox::Initialize(<a class="code" href="classv8_1_1VirtualAddressSpace.html">v8::VirtualAddressSpace</a>* vas) {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="comment">// Take the size of the virtual address space into account when determining</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="comment">// the size of the address space reservation backing the sandbox. For</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="comment">// example, if we only have a 40-bit address space, split evenly between</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="comment">// userspace and kernel, then userspace can only address 512GB and so we use</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="comment">// a quarter of that, 128GB, as maximum reservation size.</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> address_space_limit = DetermineAddressSpaceLimit();</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  <span class="comment">// Note: this is technically the maximum reservation size excluding the guard</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="comment">// regions (which are not created for partially-reserved sandboxes).</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordtype">size_t</span> max_reservation_size = address_space_limit / 4;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <span class="comment">// In any case, the sandbox should be smaller than our address space since we</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="comment">// otherwise wouldn&#39;t always be able to allocate objects inside of it.</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a45a0717f39b7011dc823c1fe7b83e6fc">CHECK_LT</a>(kSandboxSize, address_space_limit);</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160; </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordflow">if</span> (!vas-&gt;<a class="code" href="classv8_1_1VirtualAddressSpace.html#a07f77e81c5f04744cf40693915445c93">CanAllocateSubspaces</a>()) {</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="comment">// If we cannot create virtual memory subspaces, we fall back to creating a</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="comment">// partially reserved sandbox. This will happen for example on older</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="comment">// Windows versions (before Windows 10) where the necessary memory</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="comment">// management APIs, in particular, VirtualAlloc2, are not available.</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="comment">// Since reserving virtual memory is an expensive operation on Windows</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment">// before version 8.1 (reserving 1TB of address space will increase private</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="comment">// memory usage by around 2GB), we only reserve the minimal amount of</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">// address space here. This way, we don&#39;t incur the cost of reserving</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">// virtual memory, but also don&#39;t get the desired security properties as</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="comment">// unrelated mappings may end up inside the sandbox.</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    max_reservation_size = kSandboxMinimumReservationSize;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  }</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160; </div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="preprocessor">#if defined(V8_TARGET_OS_IOS)</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="comment">// If we don&#39;t override this, we will attempt to reserve 16 GB (sandbox size)</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="comment">// + 72 GB (guard region size) + 260 GB (trailing guard region size) which</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="comment">// will fail since iOS only provides ~63 GB of virtual address space of which</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  <span class="comment">// only ~51 GB can be mapped in practice. Also, the code assumes that the</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  <span class="comment">// partially reserved sandbox mode has a reservation size strictly less than</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <span class="comment">// the sandbox size which is 16 GB for iOS - using `address_space_limit / 4`</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  <span class="comment">// gives us 16 GB which won&#39;t work so use the minimum size i.e. 8 GB instead.</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  max_reservation_size = kSandboxMinimumReservationSize;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160; </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="comment">// If the maximum reservation size is less than the size of the sandbox, we</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="comment">// can only create a partially-reserved sandbox.</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="keywordtype">bool</span> success;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordtype">size_t</span> reservation_size = std::min(kSandboxSize, max_reservation_size);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(<a class="code" href="namespacev8_1_1base_1_1bits.html#af9eb752b538fa8a66badab8f26e0e000">base::bits::IsPowerOfTwo</a>(reservation_size));</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keywordflow">if</span> (reservation_size &lt; kSandboxSize) {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <a class="code" href="src_2base_2logging_8h.html#aabec5c3b7a8628298a25f044dcf89c25">DCHECK_GE</a>(max_reservation_size, kSandboxMinimumReservationSize);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    success = InitializeAsPartiallyReservedSandbox(vas, kSandboxSize,</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                                                   reservation_size);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <a class="code" href="src_2base_2logging_8h.html#af9c313d74155f7f201955a939e24c71f">DCHECK_EQ</a>(kSandboxSize, reservation_size);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    constexpr <span class="keywordtype">bool</span> use_guard_regions = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    success = Initialize(vas, kSandboxSize, use_guard_regions);</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  }</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160; </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="comment">// Fall back to creating a (smaller) partially reserved sandbox.</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="keywordflow">while</span> (!success &amp;&amp; reservation_size &gt; kSandboxMinimumReservationSize) {</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    static_assert(kFallbackToPartiallyReservedSandboxAllowed);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    reservation_size /= 2;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <a class="code" href="src_2base_2logging_8h.html#aabec5c3b7a8628298a25f044dcf89c25">DCHECK_GE</a>(reservation_size, kSandboxMinimumReservationSize);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    success = InitializeAsPartiallyReservedSandbox(vas, kSandboxSize,</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                                                   reservation_size);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160; </div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="keywordflow">if</span> (!success) {</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <a class="code" href="classv8_1_1internal_1_1V8.html#a977b087d4ee58955efe72b33136a4e94">V8::FatalProcessOutOfMemory</a>(</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <span class="keyword">nullptr</span>,</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        <span class="stringliteral">&quot;Failed to reserve the virtual address space for the V8 sandbox&quot;</span>);</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  }</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="preprocessor">#if V8_ENABLE_WEBASSEMBLY &amp;&amp; V8_TRAP_HANDLER_SUPPORTED</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="namespacev8_1_1internal_1_1trap__handler.html#af65464ae9dc36fabc95daf3d09669ed3">trap_handler::RegisterV8Sandbox</a>(base(), <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>())) {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    trap_handler_initialized_ = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <a class="code" href="classv8_1_1internal_1_1V8.html#a977b087d4ee58955efe72b33136a4e94">V8::FatalProcessOutOfMemory</a>(</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;Failed to allocate sandbox record for trap handling.&quot;</span>);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="preprocessor">#endif  </span><span class="comment">// V8_ENABLE_WEBASSEMBLY &amp;&amp; V8_TRAP_HANDLER_SUPPORTED</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160; </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="preprocessor">#ifdef V8_ENABLE_SANDBOX_HARDWARE_SUPPORT</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  SandboxHardwareSupport::RegisterSandboxMemory(base(), <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>());</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="preprocessor">#endif  </span><span class="comment">// V8_ENABLE_SANDBOX_HARDWARE_SUPPORT</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(initialized_);</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;}</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160; </div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="keywordtype">bool</span> Sandbox::Initialize(<a class="code" href="classv8_1_1VirtualAddressSpace.html">v8::VirtualAddressSpace</a>* vas, <span class="keywordtype">size_t</span> <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>,</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                         <span class="keywordtype">bool</span> use_guard_regions) {</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(!initialized_);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(<a class="code" href="namespacev8_1_1base_1_1bits.html#af9eb752b538fa8a66badab8f26e0e000">base::bits::IsPowerOfTwo</a>(<a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>));</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(vas-&gt;<a class="code" href="classv8_1_1VirtualAddressSpace.html#a07f77e81c5f04744cf40693915445c93">CanAllocateSubspaces</a>());</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160; </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  <span class="keywordtype">size_t</span> reservation_size = <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="comment">// As a temporary workaround for crbug.com/40070746 we use larger guard</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="comment">// regions at the end of the sandbox.</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="comment">// TODO(40070746): remove this workaround again once we have a proper fix.</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordtype">size_t</span> true_reservation_size = <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="preprocessor">#if defined(V8_TARGET_OS_ANDROID)</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  <span class="comment">// On Android, we often won&#39;t have sufficient virtual address space available.</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">size_t</span> kAdditionalTrailingGuardRegionSize = 0;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  <span class="comment">// Worst-case, we currently need 8 (max element size) * 32GB (max ArrayBuffer</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <span class="comment">// size) + 4GB (additional offset for TypedArray access).</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">size_t</span> kTotalTrailingGuardRegionSize = 260ULL * <a class="code" href="namespacev8_1_1internal.html#a24ba7f85e96394b19164ecd7df3988c5">GB</a>;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">size_t</span> kAdditionalTrailingGuardRegionSize =</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      kTotalTrailingGuardRegionSize - kSandboxGuardRegionSize;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="keywordflow">if</span> (use_guard_regions) {</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    reservation_size += 2 * kSandboxGuardRegionSize;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    true_reservation_size =</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        reservation_size + kAdditionalTrailingGuardRegionSize;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  }</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; </div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> hint = <a class="code" href="src_2base_2macros_8h.html#aa0de4a420e74c8df8076fc2aaf4af27a">RoundDown</a>(vas-&gt;<a class="code" href="classv8_1_1VirtualAddressSpace.html#ac7db7558b1ce5a2df1d406ff7b964cdc">RandomPageAddress</a>(), kSandboxAlignment);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160; </div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="comment">// There should be no executable pages mapped inside the sandbox since</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="comment">// those could be corrupted by an attacker and therefore pose a security</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;  <span class="comment">// risk. Furthermore, allowing executable mappings in the sandbox requires</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="comment">// MAP_JIT on macOS, which causes fork() to become excessively slow</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  <span class="comment">// (multiple seconds or even minutes for a 1TB sandbox on macOS 12.X), in</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="comment">// turn causing tests to time out. As such, the maximum page permission</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;  <span class="comment">// inside the sandbox should be read + write.</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  address_space_ =</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      vas-&gt;<a class="code" href="classv8_1_1VirtualAddressSpace.html#afdc26056f23014131110510b92ae8c61">AllocateSubspace</a>(hint, true_reservation_size, kSandboxAlignment,</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                            <a class="code" href="namespacev8.html#afd990b3ba59f8683a014651f68dd2555af34c23f2eed93c9645e1aa681c77bec5">PagePermissions::kReadWrite</a>);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="keywordflow">if</span> (!address_space_) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  reservation_base_ = address_space_-&gt;base();</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  base_ = reservation_base_ + (use_guard_regions ? kSandboxGuardRegionSize : 0);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  size_ = <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  end_ = base_ + size_;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  reservation_size_ = reservation_size;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  sandbox_page_allocator_ =</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      std::make_unique&lt;base::VirtualAddressSpacePageAllocator&gt;(</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;          address_space_.get());</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160; </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keywordflow">if</span> (use_guard_regions) {</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> front = reservation_base_;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> back = end_;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="comment">// These must succeed since nothing was allocated in the subspace yet.</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(address_space_-&gt;AllocateGuardRegion(front, kSandboxGuardRegionSize));</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(address_space_-&gt;AllocateGuardRegion(</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        back, kSandboxGuardRegionSize + kAdditionalTrailingGuardRegionSize));</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  }</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160; </div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="comment">// Also try to reserve the first 4GB of the process&#39; address space. This</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="comment">// mitigates Smi&lt;-&gt;HeapObject confusion bugs in which we end up treating a</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="comment">// Smi value as a pointer.</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="keywordflow">if</span> (!first_four_gb_of_address_space_are_reserved_) {</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> <a class="code" href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">end</a> = 4UL * <a class="code" href="namespacev8_1_1internal.html#a24ba7f85e96394b19164ecd7df3988c5">GB</a>;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="keywordtype">size_t</span> step = address_space_-&gt;allocation_granularity();</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> start = 0; start &lt;= 1 * <a class="code" href="namespacev8_1_1internal.html#af46551c5713d2a3a1be4dca973e521e0">MB</a>; start += step) {</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;      <span class="keywordflow">if</span> (vas-&gt;<a class="code" href="classv8_1_1VirtualAddressSpace.html#a33df074616690391d1cc85a4646e2862">AllocateGuardRegion</a>(start, <a class="code" href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">end</a> - start)) {</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        first_four_gb_of_address_space_are_reserved_ = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;      }</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    }</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  }</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160; </div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  initialized_ = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160; </div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  FinishInitialization();</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160; </div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(!is_partially_reserved());</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;}</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; </div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="keywordtype">bool</span> Sandbox::InitializeAsPartiallyReservedSandbox(<a class="code" href="classv8_1_1VirtualAddressSpace.html">v8::VirtualAddressSpace</a>* vas,</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                                                   <span class="keywordtype">size_t</span> <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>,</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                                                   <span class="keywordtype">size_t</span> size_to_reserve) {</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(!initialized_);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(<a class="code" href="namespacev8_1_1base_1_1bits.html#af9eb752b538fa8a66badab8f26e0e000">base::bits::IsPowerOfTwo</a>(<a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>));</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(<a class="code" href="namespacev8_1_1base_1_1bits.html#af9eb752b538fa8a66badab8f26e0e000">base::bits::IsPowerOfTwo</a>(size_to_reserve));</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a45a0717f39b7011dc823c1fe7b83e6fc">CHECK_LT</a>(size_to_reserve, <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  <span class="comment">// Use a custom random number generator here to ensure that we get uniformly</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  <span class="comment">// distributed random numbers. We figure out the available address space</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  <span class="comment">// ourselves, and so are potentially better positioned to determine a good</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  <span class="comment">// base address for the sandbox than the embedder.</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;  base::RandomNumberGenerator rng;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8_flags</a>.random_seed != 0) {</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    rng.SetSeed(<a class="code" href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8_flags</a>.random_seed);</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  }</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160; </div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="comment">// We try to ensure that base + size is still (mostly) within the process&#39;</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  <span class="comment">// address space, even though we only reserve a fraction of the memory. For</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  <span class="comment">// that, we attempt to map the sandbox into the first half of the usable</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="comment">// address space. This keeps the implementation simple and should, In any</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="comment">// realistic scenario, leave plenty of space after the actual reservation.</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> address_space_end = DetermineAddressSpaceLimit();</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> highest_allowed_address = address_space_end / 2;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(<a class="code" href="namespacev8_1_1base_1_1bits.html#af9eb752b538fa8a66badab8f26e0e000">base::bits::IsPowerOfTwo</a>(highest_allowed_address));</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  constexpr <span class="keywordtype">int</span> kMaxAttempts = 10;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespacev8_1_1internal.html">i</a> = 1; <a class="code" href="namespacev8_1_1internal.html">i</a> &lt;= kMaxAttempts; <a class="code" href="namespacev8_1_1internal.html">i</a>++) {</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> hint = rng.NextInt64() % highest_allowed_address;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    hint = <a class="code" href="src_2base_2macros_8h.html#aa0de4a420e74c8df8076fc2aaf4af27a">RoundDown</a>(hint, kSandboxAlignment);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160; </div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    reservation_base_ = vas-&gt;<a class="code" href="classv8_1_1VirtualAddressSpace.html#a507753f63e8c88702ca7f85a3f503c95">AllocatePages</a>(</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        hint, size_to_reserve, kSandboxAlignment, <a class="code" href="namespacev8.html#afd990b3ba59f8683a014651f68dd2555af5d6f15f85f8db76149a52e2f4a2aa70">PagePermissions::kNoAccess</a>);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160; </div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keywordflow">if</span> (!reservation_base_) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160; </div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="comment">// Take this base if it meets the requirements or if this is the last</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="comment">// attempt.</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">if</span> (reservation_base_ &lt;= highest_allowed_address || <a class="code" href="namespacev8_1_1internal.html">i</a> == kMaxAttempts)</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160; </div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="comment">// Can&#39;t use this base, so free the reservation and try again</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    vas-&gt;<a class="code" href="classv8_1_1VirtualAddressSpace.html#a1e0f659a566ee6d617210c91c98c2836">FreePages</a>(reservation_base_, size_to_reserve);</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    reservation_base_ = <a class="code" href="namespacev8_1_1internal.html#acf6bafb5b8483a580f375393c413ee02">kNullAddress</a>;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  }</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(reservation_base_);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160; </div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  base_ = reservation_base_;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  size_ = <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;  end_ = base_ + size_;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  reservation_size_ = size_to_reserve;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  initialized_ = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  address_space_ = std::make_unique&lt;base::EmulatedVirtualAddressSubspace&gt;(</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;      vas, reservation_base_, reservation_size_, size_);</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;  sandbox_page_allocator_ =</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      std::make_unique&lt;base::VirtualAddressSpacePageAllocator&gt;(</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;          address_space_.get());</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160; </div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;  FinishInitialization();</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160; </div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(is_partially_reserved());</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;}</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160; </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="keywordtype">void</span> Sandbox::FinishInitialization() {</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="comment">// Reserve the last page in the sandbox. This way, we can place inaccessible</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;  <span class="comment">// &quot;objects&quot; (e.g. the empty backing store buffer) there that are guaranteed</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  <span class="comment">// to cause a fault on any accidental access.</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;  <span class="comment">// Further, this also prevents the accidental construction of invalid</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  <span class="comment">// SandboxedPointers: if an ArrayBuffer is placed right at the end of the</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  <span class="comment">// sandbox, an ArrayBufferView could be constructed with byteLength=0 and</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  <span class="comment">// offset=buffer.byteLength, which would lead to a pointer that points just</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  <span class="comment">// outside of the sandbox.</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="keywordtype">size_t</span> allocation_granularity = address_space_-&gt;allocation_granularity();</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <span class="keywordtype">bool</span> success = address_space_-&gt;AllocateGuardRegion(</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      end_ - allocation_granularity, allocation_granularity);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="comment">// If the sandbox is partially-reserved, this operation may fail, for example</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="comment">// if the last page is outside of the mappable address space of the process.</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(success || is_partially_reserved());</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160; </div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;  InitializeConstants();</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;}</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160; </div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordtype">void</span> Sandbox::InitializeConstants() {</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <span class="comment">// Place the empty backing store buffer at the end of the sandbox, so that any</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  <span class="comment">// accidental access to it will most likely hit a guard page.</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  constants_.set_empty_backing_store_buffer(end_ - 1);</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;}</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160; </div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="keywordtype">void</span> Sandbox::TearDown() {</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  <span class="keywordflow">if</span> (initialized_) {</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="preprocessor">#if V8_ENABLE_WEBASSEMBLY &amp;&amp; V8_TRAP_HANDLER_SUPPORTED</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="keywordflow">if</span> (trap_handler_initialized_) {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      <a class="code" href="namespacev8_1_1internal_1_1trap__handler.html#af01d0a8a445be8e9efff75451b6b532e">trap_handler::UnregisterV8Sandbox</a>(base(), <a class="code" href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a>());</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      trap_handler_initialized_ = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    }</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="preprocessor">#endif  </span><span class="comment">// V8_ENABLE_WEBASSEMBLY &amp;&amp; V8_TRAP_HANDLER_SUPPORTED</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160; </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="comment">// This destroys the sub space and frees the underlying reservation.</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    address_space_.reset();</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    sandbox_page_allocator_.reset();</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    base_ = <a class="code" href="namespacev8_1_1internal.html#acf6bafb5b8483a580f375393c413ee02">kNullAddress</a>;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    end_ = <a class="code" href="namespacev8_1_1internal.html#acf6bafb5b8483a580f375393c413ee02">kNullAddress</a>;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    size_ = 0;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    reservation_base_ = <a class="code" href="namespacev8_1_1internal.html#acf6bafb5b8483a580f375393c413ee02">kNullAddress</a>;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    reservation_size_ = 0;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    initialized_ = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    constants_.Reset();</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  }</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;}</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160; </div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">// static</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="keywordtype">void</span> Sandbox::InitializeDefaultOncePerProcess(<a class="code" href="classv8_1_1VirtualAddressSpace.html">v8::VirtualAddressSpace</a>* vas) {</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keyword">static</span> base::LeakyObject&lt;Sandbox&gt; default_sandbox;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  default_sandbox_ = default_sandbox.get();</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160; </div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="preprocessor">#ifdef V8_COMPRESS_POINTERS_IN_MULTIPLE_CAGES</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  set_current(default_sandbox_);</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  default_sandbox_-&gt;Initialize(vas);</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;}</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160; </div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">// static</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="keywordtype">void</span> Sandbox::TearDownDefault() {</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  GetDefault()-&gt;TearDown();</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160; </div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="preprocessor">#ifdef V8_COMPRESS_POINTERS_IN_MULTIPLE_CAGES</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  set_current(<span class="keyword">nullptr</span>);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;}</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160; </div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">// static</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;Sandbox* <a class="code" href="namespacev8_1_1internal_1_1anonymous__namespace_02intl-objects_8cc_03.html#aea46070627c9c116b8f1be4a25840e66">Sandbox::New</a>(<a class="code" href="classv8_1_1VirtualAddressSpace.html">v8::VirtualAddressSpace</a>* vas) {</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="common_2globals_8h.html#a58549a1ae1607e26af5c25dbca14aaf1">COMPRESS_POINTERS_IN_MULTIPLE_CAGES_BOOL</a>) {</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <a class="code" href="src_2base_2logging_8h.html#a0d093cb749cfc7ab5993726392df681f">FATAL</a>(</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="stringliteral">&quot;Creation of new sandboxes requires enabling &quot;</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        <span class="stringliteral">&quot;multiple pointer compression cages at build-time&quot;</span>);</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  }</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  Sandbox* sandbox = <span class="keyword">new</span> Sandbox;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;  sandbox-&gt;Initialize(vas);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(!<a class="code" href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8_flags</a>.sandbox_testing &amp;&amp; !<a class="code" href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8_flags</a>.sandbox_fuzzing);</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="keywordflow">return</span> sandbox;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;}</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160; </div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="preprocessor">#endif  </span><span class="comment">// V8_ENABLE_SANDBOX</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160; </div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;}  <span class="comment">// namespace internal</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;}  <span class="comment">// namespace v8</span></div>
<div class="ttc" id="abits_8h_html"><div class="ttname"><a href="bits_8h.html">bits.h</a></div></div>
<div class="ttc" id="abounded-page-allocator_8h_html"><div class="ttname"><a href="bounded-page-allocator_8h.html">bounded-page-allocator.h</a></div></div>
<div class="ttc" id="aclassv8_1_1VirtualAddressSpace_html"><div class="ttname"><a href="classv8_1_1VirtualAddressSpace.html">v8::VirtualAddressSpace</a></div><div class="ttdoc">Class to manage a virtual memory address space.</div><div class="ttdef"><b>Definition:</b> <a href="v8-platform_8h_source.html#l00779">v8-platform.h:779</a></div></div>
<div class="ttc" id="aclassv8_1_1VirtualAddressSpace_html_a07f77e81c5f04744cf40693915445c93"><div class="ttname"><a href="classv8_1_1VirtualAddressSpace.html#a07f77e81c5f04744cf40693915445c93">v8::VirtualAddressSpace::CanAllocateSubspaces</a></div><div class="ttdeci">virtual bool CanAllocateSubspaces()=0</div><div class="ttdoc">Whether this instance can allocate subspaces or not.</div></div>
<div class="ttc" id="aclassv8_1_1VirtualAddressSpace_html_a1e0f659a566ee6d617210c91c98c2836"><div class="ttname"><a href="classv8_1_1VirtualAddressSpace.html#a1e0f659a566ee6d617210c91c98c2836">v8::VirtualAddressSpace::FreePages</a></div><div class="ttdeci">virtual void FreePages(Address address, size_t size)=0</div><div class="ttdoc">Frees previously allocated pages.</div></div>
<div class="ttc" id="aclassv8_1_1VirtualAddressSpace_html_a33df074616690391d1cc85a4646e2862"><div class="ttname"><a href="classv8_1_1VirtualAddressSpace.html#a33df074616690391d1cc85a4646e2862">v8::VirtualAddressSpace::AllocateGuardRegion</a></div><div class="ttdeci">virtual V8_WARN_UNUSED_RESULT bool AllocateGuardRegion(Address address, size_t size)=0</div><div class="ttdoc">Creates a guard region at the specified address.</div></div>
<div class="ttc" id="aclassv8_1_1VirtualAddressSpace_html_a507753f63e8c88702ca7f85a3f503c95"><div class="ttname"><a href="classv8_1_1VirtualAddressSpace.html#a507753f63e8c88702ca7f85a3f503c95">v8::VirtualAddressSpace::AllocatePages</a></div><div class="ttdeci">virtual V8_WARN_UNUSED_RESULT Address AllocatePages(Address hint, size_t size, size_t alignment, PagePermissions permissions)=0</div></div>
<div class="ttc" id="aclassv8_1_1VirtualAddressSpace_html_ac7db7558b1ce5a2df1d406ff7b964cdc"><div class="ttname"><a href="classv8_1_1VirtualAddressSpace.html#ac7db7558b1ce5a2df1d406ff7b964cdc">v8::VirtualAddressSpace::RandomPageAddress</a></div><div class="ttdeci">virtual Address RandomPageAddress()=0</div><div class="ttdoc">Returns a random address inside this address space, suitable for page allocations hints.</div></div>
<div class="ttc" id="aclassv8_1_1VirtualAddressSpace_html_afdc26056f23014131110510b92ae8c61"><div class="ttname"><a href="classv8_1_1VirtualAddressSpace.html#afdc26056f23014131110510b92ae8c61">v8::VirtualAddressSpace::AllocateSubspace</a></div><div class="ttdeci">virtual std::unique_ptr&lt; VirtualAddressSpace &gt; AllocateSubspace(Address hint, size_t size, size_t alignment, PagePermissions max_page_permissions)=0</div></div>
<div class="ttc" id="aclassv8_1_1base_1_1SysInfo_html_a5bfbc11d20bf73ed9cb8986c17d0ee4e"><div class="ttname"><a href="classv8_1_1base_1_1SysInfo.html#a5bfbc11d20bf73ed9cb8986c17d0ee4e">v8::base::SysInfo::AddressSpaceEnd</a></div><div class="ttdeci">static uintptr_t AddressSpaceEnd()</div><div class="ttdef"><b>Definition:</b> <a href="sys-info_8cc_source.html#l00136">sys-info.cc:136</a></div></div>
<div class="ttc" id="aclassv8_1_1internal_1_1V8_html_a977b087d4ee58955efe72b33136a4e94"><div class="ttname"><a href="classv8_1_1internal_1_1V8.html#a977b087d4ee58955efe72b33136a4e94">v8::internal::V8::FatalProcessOutOfMemory</a></div><div class="ttdeci">static V8_EXPORT_PRIVATE void FatalProcessOutOfMemory(Isolate *isolate, const char *location, const OOMDetails &amp;details=kNoOOMDetails)</div></div>
<div class="ttc" id="acommon_2globals_8h_html_a58549a1ae1607e26af5c25dbca14aaf1"><div class="ttname"><a href="common_2globals_8h.html#a58549a1ae1607e26af5c25dbca14aaf1">COMPRESS_POINTERS_IN_MULTIPLE_CAGES_BOOL</a></div><div class="ttdeci">#define COMPRESS_POINTERS_IN_MULTIPLE_CAGES_BOOL</div><div class="ttdef"><b>Definition:</b> <a href="common_2globals_8h_source.html#l00125">globals.h:125</a></div></div>
<div class="ttc" id="acpu_8h_html"><div class="ttname"><a href="cpu_8h.html">cpu.h</a></div></div>
<div class="ttc" id="aemulated-virtual-address-subspace_8h_html"><div class="ttname"><a href="emulated-virtual-address-subspace_8h.html">emulated-virtual-address-subspace.h</a></div></div>
<div class="ttc" id="aflag-definitions_8h_html_a3df0b28b666e942ffb9d7d04acdb9715"><div class="ttname"><a href="flag-definitions_8h.html#a3df0b28b666e942ffb9d7d04acdb9715">size</a></div><div class="ttdeci">too high values may cause the compiler to set high thresholds for inlining to as much as possible avoid inlined allocation of objects that cannot escape trace load stores from virtual maglev objects use TurboFan fast string builder analyze liveness of environment slots and zap dead values trace TurboFan load elimination emit data about basic block usage in builtins to this enable builtin reordering when run mksnapshot flag for emit warnings when applying builtin profile data verify register allocation in TurboFan randomly schedule instructions to stress dependency tracking enable store store elimination in TurboFan rewrite far to near simulate GC compiler thread race related to allow float parameters to be passed in simulator mode JS Wasm Run additional turbo_optimize_inlined_js_wasm_wrappers enables Turboshaft s StaticAssert and CheckTurboshaftTypeOf operations Wasm code into JS functions via the JS to Wasm wrappers are still inlined in TurboFan For controlling whether to at see turbo inline js wasm calls enable Turboshaft s loop unrolling enable an additional Turboshaft phase that performs optimizations based on type information enable Turbolev features that we want to ship in the not too far future trace individual Turboshaft reduction steps trace intermediate Turboshaft reduction steps trace Turboshaft s if else to switch reducer invocation count threshold for early optimization Enables optimizations which favor memory size over execution speed Enables sampling allocation profiler with X as a sample interval min size of a semi the new space consists of two semi spaces max size of the preconfigured old space size(in Mbytes)&quot;)     DEFINE_INT(random_gc_interval</div></div>
<div class="ttc" id="aflags_2flags_8h_html"><div class="ttname"><a href="flags_2flags_8h.html">flags.h</a></div></div>
<div class="ttc" id="ahardware-support_8h_html"><div class="ttname"><a href="hardware-support_8h.html">hardware-support.h</a></div></div>
<div class="ttc" id="alazy-instance_8h_html"><div class="ttname"><a href="lazy-instance_8h.html">lazy-instance.h</a></div></div>
<div class="ttc" id="anamespacev8_1_1base_1_1bits_html_a480e67428223e5edf488b15427c06d77"><div class="ttname"><a href="namespacev8_1_1base_1_1bits.html#a480e67428223e5edf488b15427c06d77">v8::base::bits::CountLeadingZeros</a></div><div class="ttdeci">constexpr unsigned CountLeadingZeros(T value) requires(std</div><div class="ttdef"><b>Definition:</b> <a href="bits_8h_source.html#l00100">bits.h:100</a></div></div>
<div class="ttc" id="anamespacev8_1_1base_1_1bits_html_af9eb752b538fa8a66badab8f26e0e000"><div class="ttname"><a href="namespacev8_1_1base_1_1bits.html#af9eb752b538fa8a66badab8f26e0e000">v8::base::bits::IsPowerOfTwo</a></div><div class="ttdeci">constexpr bool IsPowerOfTwo(T value) requires(std</div><div class="ttdef"><b>Definition:</b> <a href="bits_8h_source.html#l00187">bits.h:187</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_1_1anonymous__namespace_02intl-objects_8cc_03_html_aea46070627c9c116b8f1be4a25840e66"><div class="ttname"><a href="namespacev8_1_1internal_1_1anonymous__namespace_02intl-objects_8cc_03.html#aea46070627c9c116b8f1be4a25840e66">v8::internal::anonymous_namespace{intl-objects.cc}::New</a></div><div class="ttdeci">MaybeDirectHandle&lt; T &gt; New(Isolate *isolate, DirectHandle&lt; JSFunction &gt; constructor, DirectHandle&lt; Object &gt; locales, DirectHandle&lt; Object &gt; options, const char *method_name)</div><div class="ttdef"><b>Definition:</b> <a href="intl-objects_8cc_source.html#l00205">intl-objects.cc:205</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_1_1compiler_html_a51dcb90ae077172b12d63271c7e7ba0c"><div class="ttname"><a href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">v8::internal::compiler::end</a></div><div class="ttdeci">Node::Uses::const_iterator end(const Node::Uses &amp;uses)</div><div class="ttdef"><b>Definition:</b> <a href="node_8h_source.html#l00711">node.h:711</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_1_1trap__handler_html_af01d0a8a445be8e9efff75451b6b532e"><div class="ttname"><a href="namespacev8_1_1internal_1_1trap__handler.html#af01d0a8a445be8e9efff75451b6b532e">v8::internal::trap_handler::UnregisterV8Sandbox</a></div><div class="ttdeci">void UnregisterV8Sandbox(uintptr_t base, size_t size)</div><div class="ttdoc">Unregisters the base and size of the V8 sandbox region decribed by base and size.</div><div class="ttdef"><b>Definition:</b> <a href="handler-outside_8cc_source.html#l00258">handler-outside.cc:258</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_1_1trap__handler_html_af65464ae9dc36fabc95daf3d09669ed3"><div class="ttname"><a href="namespacev8_1_1internal_1_1trap__handler.html#af65464ae9dc36fabc95daf3d09669ed3">v8::internal::trap_handler::RegisterV8Sandbox</a></div><div class="ttdeci">bool RegisterV8Sandbox(uintptr_t base, size_t size)</div><div class="ttdoc">Registers the base and size of the V8 sandbox region into list of sandboxes records.</div><div class="ttdef"><b>Definition:</b> <a href="handler-outside_8cc_source.html#l00235">handler-outside.cc:235</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html"><div class="ttname"><a href="namespacev8_1_1internal.html">v8::internal</a></div><div class="ttdef"><b>Definition:</b> <a href="api-arguments-inl_8h_source.html#l00020">api-arguments-inl.h:20</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_a24ba7f85e96394b19164ecd7df3988c5"><div class="ttname"><a href="namespacev8_1_1internal.html#a24ba7f85e96394b19164ecd7df3988c5">v8::internal::GB</a></div><div class="ttdeci">constexpr int GB</div><div class="ttdef"><b>Definition:</b> <a href="v8-internal_8h_source.html#l00057">v8-internal.h:57</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_a5031451934208565c827c86d9eb86c5a"><div class="ttname"><a href="namespacev8_1_1internal.html#a5031451934208565c827c86d9eb86c5a">v8::internal::internal</a></div><div class="ttdeci">internal</div><div class="ttdef"><b>Definition:</b> <a href="wasm-objects-inl_8h_source.html#l00453">wasm-objects-inl.h:453</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_aa6b3743bd5d773c552654f2a6c3efa4a"><div class="ttname"><a href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">v8::internal::DCHECK</a></div><div class="ttdeci">DCHECK(IsNull(value)||IsNativeContext(value)||value==Smi::uninitialized_deserialization_value())</div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_aa9db791c05a0359859a321dcfec42e37"><div class="ttname"><a href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8::internal::v8_flags</a></div><div class="ttdeci">V8_EXPORT_PRIVATE FlagValues v8_flags</div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_ab4955debfb9384e59e3d4e9fcab5b0a0"><div class="ttname"><a href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">v8::internal::Address</a></div><div class="ttdeci">uintptr_t Address</div><div class="ttdef"><b>Definition:</b> <a href="memcopy_8h_source.html#l00022">memcopy.h:22</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_acf6bafb5b8483a580f375393c413ee02"><div class="ttname"><a href="namespacev8_1_1internal.html#acf6bafb5b8483a580f375393c413ee02">v8::internal::kNullAddress</a></div><div class="ttdeci">static constexpr Address kNullAddress</div><div class="ttdef"><b>Definition:</b> <a href="v8-internal_8h_source.html#l00053">v8-internal.h:53</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_af46551c5713d2a3a1be4dca973e521e0"><div class="ttname"><a href="namespacev8_1_1internal.html#af46551c5713d2a3a1be4dca973e521e0">v8::internal::MB</a></div><div class="ttdeci">constexpr int MB</div><div class="ttdef"><b>Definition:</b> <a href="v8-internal_8h_source.html#l00056">v8-internal.h:56</a></div></div>
<div class="ttc" id="anamespacev8_html"><div class="ttname"><a href="namespacev8.html">v8</a></div><div class="ttdoc">This file provides additional API on top of the default one for making API calls, which come from emb...</div><div class="ttdef"><b>Definition:</b> <a href="api-arguments-inl_8h_source.html#l00019">api-arguments-inl.h:19</a></div></div>
<div class="ttc" id="anamespacev8_html_afd990b3ba59f8683a014651f68dd2555af34c23f2eed93c9645e1aa681c77bec5"><div class="ttname"><a href="namespacev8.html#afd990b3ba59f8683a014651f68dd2555af34c23f2eed93c9645e1aa681c77bec5">v8::PagePermissions::kReadWrite</a></div><div class="ttdeci">@ kReadWrite</div></div>
<div class="ttc" id="anamespacev8_html_afd990b3ba59f8683a014651f68dd2555af5d6f15f85f8db76149a52e2f4a2aa70"><div class="ttname"><a href="namespacev8.html#afd990b3ba59f8683a014651f68dd2555af5d6f15f85f8db76149a52e2f4a2aa70">v8::PagePermissions::kNoAccess</a></div><div class="ttdeci">@ kNoAccess</div></div>
<div class="ttc" id="arandom-number-generator_8h_html"><div class="ttname"><a href="random-number-generator_8h.html">random-number-generator.h</a></div></div>
<div class="ttc" id="asandbox_8h_html"><div class="ttname"><a href="sandbox_8h.html">sandbox.h</a></div></div>
<div class="ttc" id="asandboxed-pointer_8h_html"><div class="ttname"><a href="sandboxed-pointer_8h.html">sandboxed-pointer.h</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_a0d093cb749cfc7ab5993726392df681f"><div class="ttname"><a href="src_2base_2logging_8h.html#a0d093cb749cfc7ab5993726392df681f">FATAL</a></div><div class="ttdeci">#define FATAL(...)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00047">logging.h:47</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_a3e1cfef60e774a81f30eaddf26a3a274"><div class="ttname"><a href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a></div><div class="ttdeci">#define CHECK(condition)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00124">logging.h:124</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_a45a0717f39b7011dc823c1fe7b83e6fc"><div class="ttname"><a href="src_2base_2logging_8h.html#a45a0717f39b7011dc823c1fe7b83e6fc">CHECK_LT</a></div><div class="ttdeci">#define CHECK_LT(lhs, rhs)</div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_aabec5c3b7a8628298a25f044dcf89c25"><div class="ttname"><a href="src_2base_2logging_8h.html#aabec5c3b7a8628298a25f044dcf89c25">DCHECK_GE</a></div><div class="ttdeci">#define DCHECK_GE(v1, v2)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00487">logging.h:487</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_af9c313d74155f7f201955a939e24c71f"><div class="ttname"><a href="src_2base_2logging_8h.html#af9c313d74155f7f201955a939e24c71f">DCHECK_EQ</a></div><div class="ttdeci">#define DCHECK_EQ(v1, v2)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00484">logging.h:484</a></div></div>
<div class="ttc" id="asrc_2base_2macros_8h_html_aa0de4a420e74c8df8076fc2aaf4af27a"><div class="ttname"><a href="src_2base_2macros_8h.html#aa0de4a420e74c8df8076fc2aaf4af27a">RoundDown</a></div><div class="ttdeci">constexpr T RoundDown(T x, intptr_t m)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2macros_8h_source.html#l00371">macros.h:371</a></div></div>
<div class="ttc" id="asrc_2utils_2allocation_8h_html"><div class="ttname"><a href="src_2utils_2allocation_8h.html">allocation.h</a></div></div>
<div class="ttc" id="asys-info_8h_html"><div class="ttname"><a href="sys-info_8h.html">sys-info.h</a></div></div>
<div class="ttc" id="av8-internal_8h_html"><div class="ttname"><a href="v8-internal_8h.html">v8-internal.h</a></div></div>
<div class="ttc" id="avirtual-address-space-page-allocator_8h_html"><div class="ttname"><a href="virtual-address-space-page-allocator_8h.html">virtual-address-space-page-allocator.h</a></div></div>
<div class="ttc" id="avirtual-address-space_8h_html"><div class="ttname"><a href="virtual-address-space_8h.html">virtual-address-space.h</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_19225156eb7ba052e31d1a736469917a.html">mnt</a></li><li class="navelem"><a class="el" href="dir_3536f6d353061322e9ef91134b76e9ed.html">V8SourceCode</a></li><li class="navelem"><a class="el" href="dir_fbd53c45610d490c9fb8d0716db4e3a3.html">src</a></li><li class="navelem"><a class="el" href="dir_d9ad92fcb1c9e950b685c3ac072f4391.html">sandbox</a></li><li class="navelem"><a class="el" href="sandbox_8cc.html">sandbox.cc</a></li>
    <li class="footer">Generated on Thu Jun 12 2025 16:00:24 for V8 Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
