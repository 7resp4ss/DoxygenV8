<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>V8 Project: /mnt/V8SourceCode/src/sandbox/external-pointer-table.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">V8 Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('external-pointer-table_8cc_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">external-pointer-table.cc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="external-pointer-table_8cc.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// Copyright 2020 the V8 project authors. All rights reserved.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// found in the LICENSE file.</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; </div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="external-pointer-table_8h.html">src/sandbox/external-pointer-table.h</a>&quot;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; </div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="execution_2isolate_8h.html">src/execution/isolate.h</a>&quot;</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="read-only-spaces_8h.html">src/heap/read-only-spaces.h</a>&quot;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="counters_8h.html">src/logging/counters.h</a>&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="external-pointer-table-inl_8h.html">src/sandbox/external-pointer-table-inl.h</a>&quot;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160; </div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#ifdef V8_COMPRESS_POINTERS</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160; </div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacev8.html">v8</a> {</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacev8_1_1internal.html#a5031451934208565c827c86d9eb86c5a">internal</a> {</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160; </div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="keywordtype">void</span> ExternalPointerTable::SetUpFromReadOnlyArtifacts(</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    Space* read_only_space, <span class="keyword">const</span> ReadOnlyArtifacts* artifacts) {</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;  UnsealReadOnlySegmentScope unseal_scope(<span class="keyword">this</span>);</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; registry_entry : artifacts-&gt;external_pointer_registry()) {</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    <a class="code" href="namespacev8_1_1internal.html#aba548aae398799ae5ad2a11ff110178b">ExternalPointerHandle</a> <a class="code" href="namespacev8_1_1internal.html#a8c89f00da07e125218128b9fbf0a321c">handle</a> = AllocateAndInitializeEntry(</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        read_only_space, registry_entry.value, registry_entry.tag);</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <a class="code" href="src_2base_2logging_8h.html#aca32614b4d2aea7dd9abdeb222bf02f3">CHECK_EQ</a>(<a class="code" href="namespacev8_1_1internal.html#a8c89f00da07e125218128b9fbf0a321c">handle</a>, registry_entry.handle);</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  }</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;}</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160; </div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// An iterator over a set of sets of segments that returns a total ordering of</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">// segments in highest to lowest address order.  This lets us easily build a</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">// sorted singly-linked freelist.</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// When given a single set of segments, it&#39;s the same as iterating over</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">// std::set&lt;Segment&gt; in reverse order.</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">// With multiple segment sets, we still produce a total order.  Sets are</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">// annotated so that we can associate some data with their segments.  This is</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">// useful when evacuating the young ExternalPointerTable::Space into the old</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">// generation in a major collection, as both spaces could have been compacting,</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">// with different starts to the evacuation area.</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> Segment, <span class="keyword">typename</span> Data&gt;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">class </span>SegmentsIterator {</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  <span class="keyword">using</span> iterator = <span class="keyword">typename</span> std::set&lt;Segment&gt;::reverse_iterator;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  <span class="keyword">using</span> const_iterator = <span class="keyword">typename</span> std::set&lt;Segment&gt;::const_reverse_iterator;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160; <span class="keyword">public</span>:</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  SegmentsIterator() = <span class="keywordflow">default</span>;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160; </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keywordtype">void</span> AddSegments(<span class="keyword">const</span> std::set&lt;Segment&gt;&amp; segments, Data data) {</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    streams_.emplace_back(segments.rbegin(), segments.rend(), data);</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  }</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160; </div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  std::optional&lt;std::pair&lt;Segment, Data&gt;&gt; <a class="code" href="namespacev8_1_1internal_1_1compiler_1_1turboshaft_1_1anonymous__namespace_02loop-unrolling-reducer_8cc_03.html#a8648e6e1be6d120a445bd087a36e5eff">Next</a>() {</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="keywordtype">int</span> stream = -1;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordtype">int</span> min_stream = -1;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    std::optional&lt;std::pair&lt;Segment, Data&gt;&gt; <a class="code" href="namespacev8_1_1base_1_1internal.html#a9840f2bf0b4780133662292486d0bc01">result</a>;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> [iter, <a class="code" href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">end</a>, data] : streams_) {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;      stream++;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;      <span class="keywordflow">if</span> (iter != <a class="code" href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">end</a>) {</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        Segment segment = *iter;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="namespacev8_1_1base_1_1internal.html#a9840f2bf0b4780133662292486d0bc01">result</a> || <a class="code" href="namespacev8_1_1base_1_1internal.html#a9840f2bf0b4780133662292486d0bc01">result</a>.value().first &lt; segment) {</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;          min_stream = stream;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;          <a class="code" href="namespacev8_1_1base_1_1internal.html#a9840f2bf0b4780133662292486d0bc01">result</a>.emplace(segment, data);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        }</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;      }</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    }</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="namespacev8_1_1base_1_1internal.html#a9840f2bf0b4780133662292486d0bc01">result</a>) {</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;      streams_[min_stream].iter++;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="namespacev8_1_1base_1_1internal.html#a9840f2bf0b4780133662292486d0bc01">result</a>;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    }</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordflow">return</span> {};</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  }</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160; </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160; <span class="keyword">private</span>:</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="keyword">struct </span>Stream {</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    iterator iter;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    const_iterator <a class="code" href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">end</a>;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    Data data;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160; </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    Stream(iterator iter, const_iterator <a class="code" href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">end</a>, Data data)</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        : iter(iter), <a class="code" href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">end</a>(<a class="code" href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">end</a>), data(data) {}</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  };</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160; </div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  std::vector&lt;Stream&gt; streams_;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;};</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;uint32_t ExternalPointerTable::EvacuateAndSweepAndCompact(Space* <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>,</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                                                          Space* from_space,</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                                                          Counters* counters) {</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;BelongsTo(<span class="keyword">this</span>));</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(!<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;is_internal_read_only_space());</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160; </div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a96a75539aa82216cdde2250a11126ea0">DCHECK_IMPLIES</a>(from_space, from_space-&gt;BelongsTo(<span class="keyword">this</span>));</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a96a75539aa82216cdde2250a11126ea0">DCHECK_IMPLIES</a>(from_space, !from_space-&gt;is_internal_read_only_space());</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160; </div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="comment">// Lock the space. Technically this is not necessary since no other thread can</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="comment">// allocate entries at this point, but some of the methods we call on the</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="comment">// space assert that the lock is held.</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <a class="code" href="namespacev8_1_1base.html#a40b71b3558e4b5297d51003612578a81">base::MutexGuard</a> guard(&amp;<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;mutex_);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="comment">// Same for the invalidated fields mutex.</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <a class="code" href="namespacev8_1_1base.html#a40b71b3558e4b5297d51003612578a81">base::MutexGuard</a> invalidated_fields_guard(&amp;<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;invalidated_fields_mutex_);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160; </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="comment">// There must not be any entry allocations while the table is being swept as</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="comment">// that would not be safe. Set the freelist to this special marker value to</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="comment">// easily catch any violation of this requirement.</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;freelist_head_.store(kEntryAllocationIsForbiddenMarker,</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                              std::memory_order_relaxed);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  SegmentsIterator&lt;Segment, CompactionResult&gt; segments_iter;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  Histogram* counter = counters-&gt;external_pointer_table_compaction_outcome();</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  CompactionResult space_compaction = FinishCompaction(<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>, counter);</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  segments_iter.AddSegments(<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;segments_, space_compaction);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <span class="comment">// If from_space is present, take its segments and add them to the sweep</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="comment">// iterator.  Wait until after the sweep to actually give from_space&#39;s</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <span class="comment">// segments to the other space, to avoid invalidating the iterator.</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  std::set&lt;Segment&gt; from_space_segments;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordflow">if</span> (from_space) {</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <a class="code" href="namespacev8_1_1base.html#a40b71b3558e4b5297d51003612578a81">base::MutexGuard</a> from_space_guard(&amp;from_space-&gt;mutex_);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <a class="code" href="namespacev8_1_1base.html#a40b71b3558e4b5297d51003612578a81">base::MutexGuard</a> from_space_invalidated_fields_guard(</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        &amp;from_space-&gt;invalidated_fields_mutex_);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    std::swap(from_space-&gt;segments_, from_space_segments);</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(from_space-&gt;segments_.empty());</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160; </div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    CompactionResult from_space_compaction =</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        FinishCompaction(from_space, counter);</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    segments_iter.AddSegments(from_space_segments, from_space_compaction);</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160; </div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    FreelistHead empty_freelist;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    from_space-&gt;freelist_head_.store(empty_freelist, std::memory_order_relaxed);</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> field : from_space-&gt;invalidated_fields_)</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;      <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;invalidated_fields_.push_back(field);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    from_space-&gt;ClearInvalidatedFields();</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  }</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160; </div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <span class="comment">// Sweep top to bottom and rebuild the freelist from newly dead and</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  <span class="comment">// previously freed entries while also clearing the marking bit on live</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="comment">// entries and resolving evacuation entries table when compacting the table.</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <span class="comment">// This way, the freelist ends up sorted by index which already makes the</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="comment">// table somewhat self-compacting and is required for the compaction</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="comment">// algorithm so that evacuated entries are evacuated to the start of a space.</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="comment">// This method must run either on the mutator thread or while the mutator is</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="comment">// stopped.</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  uint32_t current_freelist_head = 0;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  uint32_t current_freelist_length = 0;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keyword">auto</span> AddToFreelist = [&amp;](uint32_t entry_index) {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    at(entry_index).MakeFreelistEntry(current_freelist_head);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    current_freelist_head = entry_index;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    current_freelist_length++;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  };</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160; </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  std::vector&lt;Segment&gt; segments_to_deallocate;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keywordflow">while</span> (<span class="keyword">auto</span> current = segments_iter.Next()) {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    Segment segment = current-&gt;first;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    CompactionResult compaction = current-&gt;second;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordtype">bool</span> segment_will_be_evacuated =</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        compaction.success &amp;&amp;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        segment.first_entry() &gt;= compaction.start_of_evacuation_area;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160; </div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="comment">// Remember the state of the freelist before this segment in case this</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="comment">// segment turns out to be completely empty and we deallocate it.</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    uint32_t previous_freelist_head = current_freelist_head;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    uint32_t previous_freelist_length = current_freelist_length;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160; </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="comment">// Process every entry in this segment, again going top to bottom.</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keywordflow">for</span> (uint32_t <a class="code" href="namespacev8_1_1internal.html">i</a> = segment.last_entry(); <a class="code" href="namespacev8_1_1internal.html">i</a> &gt;= segment.first_entry(); <a class="code" href="namespacev8_1_1internal.html">i</a>--) {</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      <span class="keyword">auto</span> payload = at(<a class="code" href="namespacev8_1_1internal.html">i</a>).GetRawPayload();</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;      <span class="keywordflow">if</span> (payload.ContainsEvacuationEntry()) {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        <span class="comment">// Segments that will be evacuated cannot contain evacuation entries</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="comment">// into which other entries would be evacuated.</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(!segment_will_be_evacuated);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160; </div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <span class="comment">// An evacuation entry contains the address of the external pointer</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="comment">// field that owns the entry that is to be evacuated.</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> handle_location =</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;            payload.ExtractEvacuationEntryHandleLocation();</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <a class="code" href="src_2base_2logging_8h.html#a986dc8f4ec6dcd0644efe205c13f8eb7">DCHECK_NE</a>(handle_location, <a class="code" href="namespacev8_1_1internal.html#acf6bafb5b8483a580f375393c413ee02">kNullAddress</a>);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160; </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="comment">// The external pointer field may have been invalidated in the meantime</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <span class="comment">// (for example if the host object has been in-place converted to a</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="comment">// different type of object). In that case, the field no longer</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        <span class="comment">// contains an external pointer handle and we therefore cannot evacuate</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="comment">// the old entry. This is fine as the entry is guaranteed to be dead.</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;FieldWasInvalidated(handle_location)) {</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;          <span class="comment">// In this case, we must, however, free the evacuation entry.</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;          <span class="comment">// Otherwise, we would be left with effectively a stale evacuation</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;          <span class="comment">// entry that we&#39;d try to process again during the next GC.</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;          AddToFreelist(<a class="code" href="namespacev8_1_1internal.html">i</a>);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;          <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        }</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160; </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="comment">// Resolve the evacuation entry: take the pointer to the handle from the</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="comment">// evacuation entry, copy the entry to its new location, and finally</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="comment">// update the handle to point to the new entry.</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="comment">// While we now know that the entry being evacuated is free, we don&#39;t</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="comment">// add it to (the start of) the freelist because that would immediately</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="comment">// cause new fragmentation when the next entry is allocated. Instead, we</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="comment">// assume that the segments out of which entries are evacuated will all</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <span class="comment">// be decommitted anyway after this loop, which is usually the case</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="comment">// unless compaction was already aborted during marking.</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        ResolveEvacuationEntryDuringSweeping(</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;            <a class="code" href="namespacev8_1_1internal.html">i</a>, <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="namespacev8_1_1internal.html#aba548aae398799ae5ad2a11ff110178b">ExternalPointerHandle</a>*<span class="keyword">&gt;</span>(handle_location),</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;            compaction.start_of_evacuation_area);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160; </div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="comment">// The entry must now contain an external pointer and be unmarked as</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="comment">// the entry that was evacuated must have been processed already (it</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="comment">// is in an evacuated segment, which are processed first as they are</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="comment">// at the end of the space). This will have cleared the marking bit.</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(at(<a class="code" href="namespacev8_1_1internal.html">i</a>).HasExternalPointer(<a class="code" href="namespacev8_1_1internal.html#a3f4727247b13d50cf3e4754b5071a6ba">kAnyExternalPointerTagRange</a>));</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(!at(<a class="code" href="namespacev8_1_1internal.html">i</a>).GetRawPayload().HasMarkBitSet());</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!payload.HasMarkBitSet()) {</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        FreeManagedResourceIfPresent(<a class="code" href="namespacev8_1_1internal.html">i</a>);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        AddToFreelist(<a class="code" href="namespacev8_1_1internal.html">i</a>);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <span class="keyword">auto</span> new_payload = payload;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        new_payload.ClearMarkBit();</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        at(<a class="code" href="namespacev8_1_1internal.html">i</a>).SetRawPayload(new_payload);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;      <span class="comment">// We must have resolved all evacuation entries. Otherwise, we&#39;ll try to</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      <span class="comment">// process them again during the next GC, which would cause problems.</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(!at(<a class="code" href="namespacev8_1_1internal.html">i</a>).HasEvacuationEntry());</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    }</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="comment">// If a segment is completely empty, or if all live entries will be</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="comment">// evacuated out of it at the end of this loop, free the segment.</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="comment">// Note: for segments that will be evacuated, we could avoid building up a</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="comment">// freelist, but it&#39;s probably not worth the effort.</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    uint32_t free_entries = current_freelist_length - previous_freelist_length;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keywordtype">bool</span> segment_is_empty = free_entries == kEntriesPerSegment;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">if</span> (segment_is_empty || segment_will_be_evacuated) {</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;      segments_to_deallocate.push_back(segment);</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      <span class="comment">// Restore the state of the freelist before this segment.</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;      current_freelist_head = previous_freelist_head;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;      current_freelist_length = previous_freelist_length;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    }</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  }</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160; </div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;segments_.merge(from_space_segments);</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160; </div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  <span class="comment">// We cannot deallocate the segments during the above loop, so do it now.</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="keywordflow">for</span> (<span class="keyword">auto</span> segment : segments_to_deallocate) {</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="preprocessor">#ifdef DEBUG</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="comment">// There should not be any live entries in the segments we are freeing.</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="comment">// TODO(saelo): we should be able to assert here that we&#39;re not freeing any</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="comment">// entries here. Otherwise, we&#39;d have to FreeManagedResourceIfPresent.</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="comment">// for (uint32_t i = segment.last_entry(); i &gt;= segment.first_entry(); i--)</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="comment">// {</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="comment">//  CHECK(!at(i).HasExternalPointer(kAnyExternalPointerTag));</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="comment">//}</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    FreeTableSegment(segment);</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;segments_.erase(segment);</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;  }</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160; </div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;ClearInvalidatedFields();</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160; </div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  FreelistHead new_freelist(current_freelist_head, current_freelist_length);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;freelist_head_.store(new_freelist, std::memory_order_release);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#af9c313d74155f7f201955a939e24c71f">DCHECK_EQ</a>(<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;freelist_length(), current_freelist_length);</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160; </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  uint32_t num_live_entries = <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;capacity() - current_freelist_length;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  counters-&gt;external_pointers_count()-&gt;AddSample(num_live_entries);</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="keywordflow">return</span> num_live_entries;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;}</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; </div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;uint32_t ExternalPointerTable::SweepAndCompact(Space* <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>,</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                                               Counters* counters) {</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  <span class="keywordflow">return</span> EvacuateAndSweepAndCompact(<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>, <span class="keyword">nullptr</span>, counters);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;}</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160; </div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;uint32_t ExternalPointerTable::Sweep(Space* <a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>, Counters* counters) {</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">DCHECK</a>(!<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>-&gt;IsCompacting());</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;  <span class="keywordflow">return</span> SweepAndCompact(<a class="code" href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a>, counters);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;}</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160; </div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="keywordtype">void</span> ExternalPointerTable::ResolveEvacuationEntryDuringSweeping(</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    uint32_t new_index, <a class="code" href="namespacev8_1_1internal.html#aba548aae398799ae5ad2a11ff110178b">ExternalPointerHandle</a>* handle_location,</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    uint32_t start_of_evacuation_area) {</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  <span class="comment">// We must have a valid handle here. If this fails, it might mean that an</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  <span class="comment">// object with external pointers was in-place converted to another type of</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  <span class="comment">// object without informing the external pointer table.</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aba548aae398799ae5ad2a11ff110178b">ExternalPointerHandle</a> old_handle = *handle_location;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(IsValidHandle(old_handle));</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160; </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  uint32_t old_index = HandleToIndex(old_handle);</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <a class="code" href="namespacev8_1_1internal.html#aba548aae398799ae5ad2a11ff110178b">ExternalPointerHandle</a> new_handle = IndexToHandle(new_index);</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160; </div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="comment">// The compaction algorithm always moves an entry from the evacuation area to</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <span class="comment">// the front of the table. These DCHECKs verify this invariant.</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#aabec5c3b7a8628298a25f044dcf89c25">DCHECK_GE</a>(old_index, start_of_evacuation_area);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  <a class="code" href="src_2base_2logging_8h.html#af1a711c8d5520dff78858ddefd2ad668">DCHECK_LT</a>(new_index, start_of_evacuation_area);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  <span class="keyword">auto</span>&amp; new_entry = at(new_index);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  at(old_index).Evacuate(new_entry, EvacuateMarkMode::kLeaveUnmarked);</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  *handle_location = new_handle;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160; </div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  <span class="comment">// If this entry references a managed resource, update the resource to</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  <span class="comment">// reference the new entry.</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">Address</a> addr = at(new_index).ExtractManagedResourceOrNull()) {</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    ManagedResource* resource = <span class="keyword">reinterpret_cast&lt;</span>ManagedResource*<span class="keyword">&gt;</span>(addr);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <a class="code" href="src_2base_2logging_8h.html#af9c313d74155f7f201955a939e24c71f">DCHECK_EQ</a>(resource-&gt;ept_entry_, old_handle);</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    resource-&gt;ept_entry_ = new_handle;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  }</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;}</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160; </div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;}  <span class="comment">// namespace internal</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;}  <span class="comment">// namespace v8</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160; </div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="preprocessor">#endif  </span><span class="comment">// V8_COMPRESS_POINTERS</span></div>
<div class="ttc" id="acounters_8h_html"><div class="ttname"><a href="counters_8h.html">counters.h</a></div></div>
<div class="ttc" id="aexecution_2isolate_8h_html"><div class="ttname"><a href="execution_2isolate_8h.html">isolate.h</a></div></div>
<div class="ttc" id="aexternal-pointer-table-inl_8h_html"><div class="ttname"><a href="external-pointer-table-inl_8h.html">external-pointer-table-inl.h</a></div></div>
<div class="ttc" id="aexternal-pointer-table_8h_html"><div class="ttname"><a href="external-pointer-table_8h.html">external-pointer-table.h</a></div></div>
<div class="ttc" id="aflag-definitions_8h_html_a087fd0337c14e102a4a2abccd41a39ad"><div class="ttname"><a href="flag-definitions_8h.html#a087fd0337c14e102a4a2abccd41a39ad">space</a></div><div class="ttdeci">too high values may cause the compiler to set high thresholds for inlining to as much as possible avoid inlined allocation of objects that cannot escape trace load stores from virtual maglev objects use TurboFan fast string builder analyze liveness of environment slots and zap dead values trace TurboFan load elimination emit data about basic block usage in builtins to this enable builtin reordering when run mksnapshot flag for emit warnings when applying builtin profile data verify register allocation in TurboFan randomly schedule instructions to stress dependency tracking enable store store elimination in TurboFan rewrite far to near simulate GC compiler thread race related to allow float parameters to be passed in simulator mode JS Wasm Run additional turbo_optimize_inlined_js_wasm_wrappers enables Turboshaft s StaticAssert and CheckTurboshaftTypeOf operations Wasm code into JS functions via the JS to Wasm wrappers are still inlined in TurboFan For controlling whether to at see turbo inline js wasm calls enable Turboshaft s loop unrolling enable an additional Turboshaft phase that performs optimizations based on type information enable Turbolev features that we want to ship in the not too far future trace individual Turboshaft reduction steps trace intermediate Turboshaft reduction steps trace Turboshaft s if else to switch reducer invocation count threshold for early optimization Enables optimizations which favor memory size over execution speed Enables sampling allocation profiler with X as a sample interval min size of a semi the new space consists of two semi spaces max size of the preconfigured old space Collect garbage after Collect garbage after keeps maps alive for&lt; n &gt; old space garbage collections print one detailed trace line in allocation gc speed threshold for starting incremental marking via a task in percent of available space</div><div class="ttdef"><b>Definition:</b> <a href="flag-definitions_8h_source.html#l02215">flag-definitions.h:2213</a></div></div>
<div class="ttc" id="anamespacev8_1_1base_1_1internal_html_a9840f2bf0b4780133662292486d0bc01"><div class="ttname"><a href="namespacev8_1_1base_1_1internal.html#a9840f2bf0b4780133662292486d0bc01">v8::base::internal::result</a></div><div class="ttdeci">V result</div><div class="ttdef"><b>Definition:</b> <a href="clamped__math__impl_8h_source.html#l00082">clamped_math_impl.h:82</a></div></div>
<div class="ttc" id="anamespacev8_1_1base_html_a40b71b3558e4b5297d51003612578a81"><div class="ttname"><a href="namespacev8_1_1base.html#a40b71b3558e4b5297d51003612578a81">v8::base::MutexGuard</a></div><div class="ttdeci">LockGuard&lt; Mutex &gt; MutexGuard</div><div class="ttdef"><b>Definition:</b> <a href="mutex_8h_source.html#l00219">mutex.h:219</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_1_1compiler_1_1turboshaft_1_1anonymous__namespace_02loop-unrolling-reducer_8cc_03_html_a8648e6e1be6d120a445bd087a36e5eff"><div class="ttname"><a href="namespacev8_1_1internal_1_1compiler_1_1turboshaft_1_1anonymous__namespace_02loop-unrolling-reducer_8cc_03.html#a8648e6e1be6d120a445bd087a36e5eff">v8::internal::compiler::turboshaft::anonymous_namespace{loop-unrolling-reducer.cc}::Next</a></div><div class="ttdeci">std::optional&lt; Int &gt; Next(Int val, Int incr, StaticCanonicalForLoopMatcher::BinOp binop_op, WordRepresentation binop_rep)</div><div class="ttdef"><b>Definition:</b> <a href="loop-unrolling-reducer_8cc_source.html#l00306">loop-unrolling-reducer.cc:306</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_1_1compiler_html_a51dcb90ae077172b12d63271c7e7ba0c"><div class="ttname"><a href="namespacev8_1_1internal_1_1compiler.html#a51dcb90ae077172b12d63271c7e7ba0c">v8::internal::compiler::end</a></div><div class="ttdeci">Node::Uses::const_iterator end(const Node::Uses &amp;uses)</div><div class="ttdef"><b>Definition:</b> <a href="node_8h_source.html#l00711">node.h:711</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html"><div class="ttname"><a href="namespacev8_1_1internal.html">v8::internal</a></div><div class="ttdef"><b>Definition:</b> <a href="api-arguments-inl_8h_source.html#l00020">api-arguments-inl.h:20</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_a3f4727247b13d50cf3e4754b5071a6ba"><div class="ttname"><a href="namespacev8_1_1internal.html#a3f4727247b13d50cf3e4754b5071a6ba">v8::internal::kAnyExternalPointerTagRange</a></div><div class="ttdeci">constexpr ExternalPointerTagRange kAnyExternalPointerTagRange(kFirstExternalPointerTag, kLastExternalPointerTag)</div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_a5031451934208565c827c86d9eb86c5a"><div class="ttname"><a href="namespacev8_1_1internal.html#a5031451934208565c827c86d9eb86c5a">v8::internal::internal</a></div><div class="ttdeci">internal</div><div class="ttdef"><b>Definition:</b> <a href="wasm-objects-inl_8h_source.html#l00453">wasm-objects-inl.h:453</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_a8c89f00da07e125218128b9fbf0a321c"><div class="ttname"><a href="namespacev8_1_1internal.html#a8c89f00da07e125218128b9fbf0a321c">v8::internal::handle</a></div><div class="ttdeci">IndirectHandle&lt; T &gt; handle(Tagged&lt; T &gt; object, Isolate *isolate)</div><div class="ttdef"><b>Definition:</b> <a href="handles-inl_8h_source.html#l00072">handles-inl.h:72</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_aa6b3743bd5d773c552654f2a6c3efa4a"><div class="ttname"><a href="namespacev8_1_1internal.html#aa6b3743bd5d773c552654f2a6c3efa4a">v8::internal::DCHECK</a></div><div class="ttdeci">DCHECK(IsNull(value)||IsNativeContext(value)||value==Smi::uninitialized_deserialization_value())</div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_ab4955debfb9384e59e3d4e9fcab5b0a0"><div class="ttname"><a href="namespacev8_1_1internal.html#ab4955debfb9384e59e3d4e9fcab5b0a0">v8::internal::Address</a></div><div class="ttdeci">uintptr_t Address</div><div class="ttdef"><b>Definition:</b> <a href="memcopy_8h_source.html#l00022">memcopy.h:22</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_aba548aae398799ae5ad2a11ff110178b"><div class="ttname"><a href="namespacev8_1_1internal.html#aba548aae398799ae5ad2a11ff110178b">v8::internal::ExternalPointerHandle</a></div><div class="ttdeci">uint32_t ExternalPointerHandle</div><div class="ttdef"><b>Definition:</b> <a href="v8-internal_8h_source.html#l00363">v8-internal.h:363</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_acf6bafb5b8483a580f375393c413ee02"><div class="ttname"><a href="namespacev8_1_1internal.html#acf6bafb5b8483a580f375393c413ee02">v8::internal::kNullAddress</a></div><div class="ttdeci">static constexpr Address kNullAddress</div><div class="ttdef"><b>Definition:</b> <a href="v8-internal_8h_source.html#l00053">v8-internal.h:53</a></div></div>
<div class="ttc" id="anamespacev8_html"><div class="ttname"><a href="namespacev8.html">v8</a></div><div class="ttdoc">This file provides additional API on top of the default one for making API calls, which come from emb...</div><div class="ttdef"><b>Definition:</b> <a href="api-arguments-inl_8h_source.html#l00019">api-arguments-inl.h:19</a></div></div>
<div class="ttc" id="aread-only-spaces_8h_html"><div class="ttname"><a href="read-only-spaces_8h.html">read-only-spaces.h</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_a3e1cfef60e774a81f30eaddf26a3a274"><div class="ttname"><a href="src_2base_2logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a></div><div class="ttdeci">#define CHECK(condition)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00124">logging.h:124</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_a96a75539aa82216cdde2250a11126ea0"><div class="ttname"><a href="src_2base_2logging_8h.html#a96a75539aa82216cdde2250a11126ea0">DCHECK_IMPLIES</a></div><div class="ttdeci">#define DCHECK_IMPLIES(v1, v2)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00492">logging.h:492</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_a986dc8f4ec6dcd0644efe205c13f8eb7"><div class="ttname"><a href="src_2base_2logging_8h.html#a986dc8f4ec6dcd0644efe205c13f8eb7">DCHECK_NE</a></div><div class="ttdeci">#define DCHECK_NE(v1, v2)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00485">logging.h:485</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_aabec5c3b7a8628298a25f044dcf89c25"><div class="ttname"><a href="src_2base_2logging_8h.html#aabec5c3b7a8628298a25f044dcf89c25">DCHECK_GE</a></div><div class="ttdeci">#define DCHECK_GE(v1, v2)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00487">logging.h:487</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_aca32614b4d2aea7dd9abdeb222bf02f3"><div class="ttname"><a href="src_2base_2logging_8h.html#aca32614b4d2aea7dd9abdeb222bf02f3">CHECK_EQ</a></div><div class="ttdeci">#define CHECK_EQ(lhs, rhs)</div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_af1a711c8d5520dff78858ddefd2ad668"><div class="ttname"><a href="src_2base_2logging_8h.html#af1a711c8d5520dff78858ddefd2ad668">DCHECK_LT</a></div><div class="ttdeci">#define DCHECK_LT(v1, v2)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00488">logging.h:488</a></div></div>
<div class="ttc" id="asrc_2base_2logging_8h_html_af9c313d74155f7f201955a939e24c71f"><div class="ttname"><a href="src_2base_2logging_8h.html#af9c313d74155f7f201955a939e24c71f">DCHECK_EQ</a></div><div class="ttdeci">#define DCHECK_EQ(v1, v2)</div><div class="ttdef"><b>Definition:</b> <a href="src_2base_2logging_8h_source.html#l00484">logging.h:484</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_19225156eb7ba052e31d1a736469917a.html">mnt</a></li><li class="navelem"><a class="el" href="dir_3536f6d353061322e9ef91134b76e9ed.html">V8SourceCode</a></li><li class="navelem"><a class="el" href="dir_fbd53c45610d490c9fb8d0716db4e3a3.html">src</a></li><li class="navelem"><a class="el" href="dir_d9ad92fcb1c9e950b685c3ac072f4391.html">sandbox</a></li><li class="navelem"><a class="el" href="external-pointer-table_8cc.html">external-pointer-table.cc</a></li>
    <li class="footer">Generated on Thu Jun 12 2025 16:00:24 for V8 Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
